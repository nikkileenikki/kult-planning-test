import{j as a}from"./index-C1JaId44.js";import{r as z,d as ca}from"./vendor-7lAwbL4C.js";import{L as ua}from"./Layout-BIIFe71_.js";import{C as da}from"./CampaignBriefPanel-_Oolbo2H.js";import{a as de}from"./utils-B9ygI19o.js";const ma={automotive_ice:{primary_personas:["Automotive Enthusiasts","Automotive Intent","Gadget Gurus","Emerging Affluents","Young Working Adult"],secondary_personas:[],key_ips:["Sooka","YouTube Channels","Astro GO","Stadium Astro","Hotspot","Roda Panas"],watchouts:["Never use FMCG personas"]},automotive_ev:{primary_personas:["Automotive Enthusiasts","Tech & Gadget Enthusiasts","Emerging Affluents"],secondary_personas:[],key_ips:["Astro GO","Sooka","Awani","Stadium Astro"],watchouts:["Avoid mass targeting"]},property_luxury:{primary_personas:["Home Buyers","Luxury Buyers","Emerging Affluents","Business & Professional"],secondary_personas:[],key_ips:["Nona","PaMa","Pesona Pengantin","Impiana","Keluarga","Astro GO","Sooka"],watchouts:["Persona must match price tier"]},property_mid_range:{primary_personas:["Home Buyers","Family Dynamic","Emerging Affluents"],secondary_personas:[],key_ips:["Impiana","Keluarga","PaMa","Astro GO"],watchouts:["Avoid general mass personas"]},property_affordable:{primary_personas:["Family Dynamic","Students","Youth Mom"],secondary_personas:[],key_ips:["Keluarga","PaMa","Gempak"],watchouts:["Do not overspend on premium inventory"]},fmcg:{primary_personas:["Foodies","Health & Wellness Shoppers","Youth Mom","Family Dynamic"],secondary_personas:[],key_ips:["Rasa","Bintang Kecil","Era","Mingguan Wanita"],watchouts:["Avoid premium/luxury personas"]},beauty:{primary_personas:["Fashion Icons","Young Working Adult","Youth Mom"],secondary_personas:[],key_ips:["Hijabista","Remaja","Nona","Gempak","Mingguan Wanita","Xuan"],watchouts:["Avoid over-targeting one female segment"]},retail_ecommerce:{primary_personas:["Online Shoppers","Fashion Icons","Family Dynamic","Students"],secondary_personas:[],key_ips:["Gempak","Xuan","Hitz","Era"],watchouts:["Wrong price targeting"]},finance_insurance:{primary_personas:["Corporate Visionaries","Business & Professional","Emerging Affluents"],secondary_personas:[],key_ips:["Awani","Astro GO","Mix","Lite","My"],watchouts:["Avoid low-quality sites"]},telco:{primary_personas:["Students","Young Working Adult","Emerging Affluents"],secondary_personas:[],key_ips:["Hitz","My","Sinar","Xuan","Gempak"],watchouts:["Offer must be clear"]},travel:{primary_personas:["Travel & Experience Seekers","Adventure Enthusiasts"],secondary_personas:[],key_ips:["Libur","Sooka","Astro GO","Makan Bola"],watchouts:["Seasonality"]},education:{primary_personas:["Students","Youth Mom","Little Steps Advocates"],secondary_personas:[],key_ips:["PaMa","Remaja","Keluarga","Xuan"],watchouts:["Long conversion time"]},f_b:{primary_personas:["Foodies","Family Dynamic"],secondary_personas:[],key_ips:["Rasa","Libur","Era","Melody"],watchouts:["Low conversion"]},sme_b2b:{primary_personas:["SME","Corporate Visionaries","Business & Professional","Start-ups"],secondary_personas:[],key_ips:["Awani","Astro GO","RojakDaily"],watchouts:["Avoid mass audiences"]},tech_devices:{primary_personas:["Gadget Gurus","Esports Fans"],secondary_personas:[],key_ips:["Stadium Astro","Sooka","Astro GO","Hotspot"],watchouts:["High CPAs expected"]},banking_fintech:{primary_personas:["Emerging Affluents","Business & Professional"],secondary_personas:[],key_ips:["Awani","My","Astro GO","Sinar"],watchouts:["Must show offer"]},entertainment_ott:{primary_personas:["Music","Animation","Sports","EPL Fans","Comedy","Horror"],secondary_personas:[],key_ips:["Stadium Astro","Astro GO","Sooka","Gempak"],watchouts:["Genre mismatch"]},gaming:{primary_personas:["Esports Fans","Tech & Gadget Enthusiasts","Students"],secondary_personas:[],key_ips:["Stadium Astro","Sooka","Hotspot"],watchouts:["High wastage risk"]},luxury:{primary_personas:["Luxury Seekers","Luxury Buyers","Emerging Affluents"],secondary_personas:[],key_ips:["Nona","Pesona Pengantin","Hijabista","VanillaKismis"],watchouts:["Wrong geo"]},lifestyle:{primary_personas:["Active Lifestyle Seekers","Travel Seekers","Adventure","Eco","Romantic Comedy"],secondary_personas:[],key_ips:["Astro GO","Sooka","Gempak"],watchouts:["Wrong context"]}},ga={automotive_ice:{label:"Automotive (ICE)",strategy_dna:"Awareness + High Consideration",funnel:{awareness:["Product Collector","Data Capture","In-stream","In-Read","Video In-Banner","Interstitial","Countdown","Mini Game","Carousel"],consideration:["Product Collector","Data Capture","In-stream","In-Read","Video In-Banner","Interstitial","Countdown","Mini Game","Carousel"],conversion:["Product Collector","Data Capture","In-stream","In-Read","Video In-Banner","Interstitial","Countdown","Mini Game","Carousel"]}},automotive_ev:{label:"Automotive (EV)",strategy_dna:"Education + Lead",funnel:{awareness:["Data Capture","Product Collector","In-stream","Calculator Ads"],consideration:["Data Capture","Product Collector","In-stream","Calculator Ads"],conversion:["Data Capture","Product Collector","In-stream","Calculator Ads"]}},property_luxury:{label:"Property ‚Äì Luxury",strategy_dna:"Premium Awareness + Lead Gen",funnel:{awareness:["Calculator","Data Capture","In-stream","Carousel","Skinner","Masthead","Site Takeover"],consideration:["Calculator","Data Capture","In-stream","Carousel","Skinner","Masthead","Site Takeover"],conversion:["Calculator","Data Capture","In-stream","Carousel","Skinner","Masthead","Site Takeover"]}},property_mid_range:{label:"Property ‚Äì Mid Range",strategy_dna:"Lead + Filtering",funnel:{awareness:["Rich Media","Lead Formats","Carousel","Calculator"],consideration:["Rich Media","Lead Formats","Carousel","Calculator"],conversion:["Rich Media","Lead Formats","Carousel","Calculator"]}},property_affordable:{label:"Property ‚Äì Affordable",strategy_dna:"High-volume awareness",funnel:{awareness:["Display","Social","Retargeting"],consideration:["Display","Social","Retargeting"],conversion:["Display","Social","Retargeting"]}},fmcg:{label:"FMCG",strategy_dna:"Volume reach + Frequency",funnel:{awareness:["Skinner","Masthead","Site Takeover","Leaderboard","MerryView","In-Stream"],consideration:["Skinner","Masthead","Site Takeover","Leaderboard","MerryView","In-Stream"],conversion:["Skinner","Masthead","Site Takeover","Leaderboard","MerryView","In-Stream"]}},beauty:{label:"Beauty",strategy_dna:"Social + Video",funnel:{awareness:["Product Collector","Carousel","In-Banner Video","Hotspot","Mini-Game"],consideration:["Product Collector","Carousel","In-Banner Video","Hotspot","Mini-Game"],conversion:["Product Collector","Carousel","In-Banner Video","Hotspot","Mini-Game"]}},retail_ecommerce:{label:"Retail / eCommerce",strategy_dna:"Performance + Retargeting",funnel:{awareness:["Countdown","Product Collector","Carousel","Catfish","MREC","Leaderboard"],consideration:["Countdown","Product Collector","Carousel","Catfish","MREC","Leaderboard"],conversion:["Countdown","Product Collector","Carousel","Catfish","MREC","Leaderboard"]}},finance_insurance:{label:"Finance / Insurance",strategy_dna:"Multi-step funnel",funnel:{awareness:["Calculator","Data Capture","Carousel","In-stream"],consideration:["Calculator","Data Capture","Carousel","In-stream"],conversion:["Calculator","Data Capture","Carousel","In-stream"]}},telco:{label:"Telco",strategy_dna:"Offer-first + Conversion",funnel:{awareness:["Carousel","Interstitial","Countdown","Mobile Banners"],consideration:["Carousel","Interstitial","Countdown","Mobile Banners"],conversion:["Carousel","Interstitial","Countdown","Mobile Banners"]}},travel:{label:"Travel",strategy_dna:"Promo + Inspiration",funnel:{awareness:["Countdown","Carousel","In-stream","MerryView"],consideration:["Countdown","Carousel","In-stream","MerryView"],conversion:["Countdown","Carousel","In-stream","MerryView"]}},education:{label:"Education",strategy_dna:"Lead-first",funnel:{awareness:["Lead Form","Carousel","Calculator"],consideration:["Lead Form","Carousel","Calculator"],conversion:["Lead Form","Carousel","Calculator"]}},f_b:{label:"F&B",strategy_dna:"Short-video + Proximity",funnel:{awareness:["Catfish","Carousel","Leaderboard","Mobile Banner"],consideration:["Catfish","Carousel","Leaderboard","Mobile Banner"],conversion:["Catfish","Carousel","Leaderboard","Mobile Banner"]}},sme_b2b:{label:"SME / B2B",strategy_dna:"Lead + Trust",funnel:{awareness:["Calculator","Lead Form","Data Capture","Carousel"],consideration:["Calculator","Lead Form","Data Capture","Carousel"],conversion:["Calculator","Lead Form","Data Capture","Carousel"]}},tech_devices:{label:"Tech & Devices",strategy_dna:"Education + Comparison",funnel:{awareness:["Product Collector","CubeVibe","Countdown","In-stream"],consideration:["Product Collector","CubeVibe","Countdown","In-stream"],conversion:["Product Collector","CubeVibe","Countdown","In-stream"]}},banking_fintech:{label:"Banking / Fintech",strategy_dna:"Lead > Consideration",funnel:{awareness:["Calculator","Lead Form","Carousel"],consideration:["Calculator","Lead Form","Carousel"],conversion:["Calculator","Lead Form","Carousel"]}},entertainment_ott:{label:"Entertainment / OTT",strategy_dna:"Hype + Video",funnel:{awareness:["Trailer","In-stream","MerryView","Skinner","Site Takeover"],consideration:["Trailer","In-stream","MerryView","Skinner","Site Takeover"],conversion:["Trailer","In-stream","MerryView","Skinner","Site Takeover"]}},gaming:{label:"Gaming",strategy_dna:"Short Video + Engagement",funnel:{awareness:["Mini Game","CubeVibe","Video In-Banner","In-stream"],consideration:["Mini Game","CubeVibe","Video In-Banner","In-stream"],conversion:["Mini Game","CubeVibe","Video In-Banner","In-stream"]}},luxury:{label:"Luxury",strategy_dna:"Premium Awareness",funnel:{awareness:["Skinner","Masthead","Site Takeover","Interstitial"],consideration:["Skinner","Masthead","Site Takeover","Interstitial"],conversion:["Skinner","Masthead","Site Takeover","Interstitial"]}},lifestyle:{label:"Lifestyle",strategy_dna:"Storytelling",funnel:{awareness:["OTT Video","Rich Media"],consideration:["OTT Video","Rich Media"],conversion:["OTT Video","Rich Media"]}}},ke={persona_mapping:ma,vertical_playbook:ga},pa="https://kult-planning-test-production.up.railway.app",Lt=s=>{const o=s.startsWith("/")?s.slice(1):s;return`${pa}/${o}`};function fa(){const[s,o]=z.useState(!1),[r,f]=z.useState(null),l=z.useRef(null);return{sendMessage:async(b,j=[],O={},F={})=>{l.current&&l.current.abort(),l.current=new AbortController,o(!0),f(null);try{console.log("[AI CHAT HOOK] Sending message:",b),console.log("[AI CHAT HOOK] History length:",j.length),console.log("[AI CHAT HOOK] Current brief:",O),console.log("[AI CHAT HOOK] Extracted entities:",F);const G=await fetch(Lt("ai-chat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:b,conversationHistory:j,currentBrief:O,extractedEntities:F}),signal:l.current.signal});if(!G.ok){const X=await G.json();throw new Error(X.error||"Failed to get AI response")}const J=await G.json();return console.log("[AI CHAT HOOK] Response received:",J),l.current=null,o(!1),{success:!0,response:J.response,extractedEntities:J.extractedEntities||{},metadata:J.metadata||{}}}catch(G){return G.name==="AbortError"?(console.log("[AI CHAT HOOK] Request cancelled by user"),o(!1),{success:!1,cancelled:!0,error:"Request cancelled",response:"",extractedEntities:{}}):(console.error("[AI CHAT HOOK ERROR]:",G),f(G.message),l.current=null,o(!1),{success:!1,error:G.message,response:"I'm having trouble processing your request. Could you try rephrasing?",extractedEntities:{}})}},cancelRequest:()=>{l.current&&(console.log("[AI CHAT HOOK] Cancelling request..."),l.current.abort(),l.current=null,o(!1))},checkAvailability:async()=>{try{return await(await fetch(Lt("ai-chat/status"))).json()}catch(b){return console.error("[AI CHAT HOOK] Status check failed:",b),{available:!1,error:b.message}}},isLoading:s,error:r}}const ha={beauty:["beauty","beauty_cosmetics","beauty_&_cosmetics"],beauty_cosmetics:["beauty","beauty_&_cosmetics"],"beauty_&_cosmetics":["beauty","beauty_cosmetics"],automotive:["automotive","automotive_ice","automotive_ev"],automotive_ice:["automotive"],automotive_ev:["automotive"],property:["property","property_luxury","property_mid_range","property_affordable"],property_luxury:["property"],property_mid_range:["property"],property_affordable:["property"],finance:["finance_insurance","finance","banking"],banking:["finance_insurance","finance","banking"],finance_insurance:["finance","banking"],retail:["retail_ecommerce","retail","ecommerce"],retail_ecommerce:["retail","ecommerce"],ecommerce:["retail_ecommerce","retail"],fmcg:["fmcg"],telco:["telco","telecommunications"],telecommunications:["telco"],"f&b":["f_b","food_beverage","fnb"],food_beverage:["f&b","f_b","fnb"],travel:["travel_tourism","travel","tourism"],travel_tourism:["travel","tourism"],tourism:["travel_tourism","travel"]};function De(s){return s?s.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,""):null}function ya(s,o){var l,w,g,d;if(!s||!o)return null;const r=De(s);if((l=o.vertical_playbook)!=null&&l[r])return console.log(`üìñ [PLAYBOOK] Found industry playbook: ${r}`),{config:o.vertical_playbook[r],personas:((w=o.persona_mapping)==null?void 0:w[r])||null,source:"industry",key:r,label:o.vertical_playbook[r].label||s};const f=ha[r]||[];for(const b of f)if((g=o.vertical_playbook)!=null&&g[b])return console.log(`üìñ [PLAYBOOK] Found via alias: ${r} ‚Üí ${b}`),{config:o.vertical_playbook[b],personas:((d=o.persona_mapping)==null?void 0:d[b])||null,source:"industry",key:b,label:o.vertical_playbook[b].label||s};return console.log(`‚ö†Ô∏è [PLAYBOOK] No industry-specific playbook found for: ${r}`),null}function ba(){return console.log("üîß [PLAYBOOK] Using GENERIC fallback playbook"),{config:{label:"Generic",strategy_dna:"Balanced multi-channel approach",funnel:{awareness:["video","display","native"],consideration:["interactive","rich media","carousel"],conversion:["display","native","retargeting"]}},personas:null,source:"generic",key:"generic",label:"Generic"}}const va=["beauty","beauty_cosmetics","beauty_&_cosmetics","finance","finance_insurance","banking","automotive","automotive_ice","automotive_ev","property","property_luxury","property_mid_range","property_affordable"],wa={beauty:["Fashion Icons","Young Working Adult","Youth Mom","Emerging Affluents"],beauty_cosmetics:["Fashion Icons","Young Working Adult","Youth Mom","Emerging Affluents"],"beauty_&_cosmetics":["Fashion Icons","Young Working Adult","Youth Mom","Emerging Affluents"],finance:["Business & Professional","Emerging Affluents","Young Working Adult","Family Dynamic"],finance_insurance:["Business & Professional","Emerging Affluents","Young Working Adult","Family Dynamic"],banking:["Business & Professional","Emerging Affluents","Young Working Adult","Family Dynamic"],automotive:["Automotive Enthusiasts","Gadget Gurus","Emerging Affluents","Young Working Adult"],automotive_ice:["Automotive Enthusiasts","Gadget Gurus","Emerging Affluents","Young Working Adult"],automotive_ev:["Automotive Enthusiasts","Tech & Gadget Enthusiasts","Emerging Affluents"],property:["Home Buyers","Emerging Affluents","Business & Professional","Family Dynamic"],property_luxury:["Home Buyers","Luxury Buyers","Emerging Affluents","Business & Professional"],property_mid_range:["Home Buyers","Family Dynamic","Emerging Affluents"],property_affordable:["Family Dynamic","Students","Youth Mom"]};function Ca(s){const o=De(s);return va.includes(o)}function xa(s){const o=De(s);return wa[o]||[]}const Mt={OTT:{minShare:.6,maxOtherShare:.3,keywords:["stream","video","ott","ctv","youtube","astro","viu","iflix","sooka"],channelLabel:"OTT/Streaming"},Social:{minShare:.6,maxOtherShare:.3,keywords:["social","facebook","instagram","tiktok","meta","feed","story","reel"],channelLabel:"Social Media"},Display:{minShare:.6,maxOtherShare:.3,keywords:["display","banner","native","programmatic","leaderboard","mrec","skyscraper"],channelLabel:"Display/Programmatic"}};function tt(s,o){let r=0,f=0;const l=[],w=[];for(const g of s){const d=(g.platform||"").toLowerCase(),b=(g.format||g.formatName||"").toLowerCase(),j=`${d} ${b}`;o.some(F=>j.includes(F))?(r+=g.allocatedBudget||0,l.push(g)):(f+=g.allocatedBudget||0,w.push(g))}return{preferred:r,other:f,items:{preferred:l,other:w}}}function ka(s,o,r){const f=tt(s,o.keywords),l=r*o.minShare,w=l-f.preferred;if(w<=0)return s;console.log(`   üîß Rebalancing: Need additional ${w.toLocaleString()} for ${o.channelLabel}`);const g=f.items.preferred,d=f.items.other;if(g.length===0)return console.log(`   ‚ö†Ô∏è No ${o.channelLabel} items to boost!`),s;const b=l/f.preferred;g.forEach(O=>{O.allocatedBudget*=b});const j=r-l;if(d.length>0&&f.other>0){const O=j/f.other;d.forEach(F=>{F.allocatedBudget*=O})}return s}const Sa=(s,o,r=!1)=>{if(r||!s||s.length===0)return 1;const f=1615e4;let l=0;s.forEach(g=>{const d=o.find(b=>b.persona===g||b.name===g);d&&d.totalAudience&&(l+=d.totalAudience)});const w=l/f;return console.log("üéØ Persona Targeting Ratio:",{selectedPersonas:s.slice(0,3),totalReach:l.toLocaleString(),basePopulation:f.toLocaleString(),ratio:`${(w*100).toFixed(1)}%`}),Math.min(1,w)},Aa=(s,o,r=[],f=1)=>{if(!s||s.length===0)return{totalRequests:0,totalImpressions:0,availableInventory:0,formats:[],personaRatio:1};const l=(r||[]).map(X=>X.toLowerCase()),g=["bahasa malaysia","english","chinese"].every(X=>l.some(oe=>oe.includes(X.split(" ")[0])));let d=0,b=0;const j=[],O={leaderboard:"leaderboard",mrec:"mrec",masthead:"masthead","half page":"mrec","mobile banner":"leaderboard",interstitial:"interstitial","in-article":"in article","in-image":"in image",catfish:"catfish","instream video":"pre/midroll","in-stream video":"pre/midroll","pre-roll":"preroll","mid-roll":"midroll","image social ad":"social static ad","video social ad":"social video ad",skinner:"masthead",wallpaper:"masthead",takeover:"interstitial"};s.forEach(X=>{const oe=(X.name||X["Ad format"]||"").toLowerCase(),K=(X.type||"").toLowerCase().includes("interactive");let p=null,se=!1;if(K)se=!0;else if(p=o[oe],!p){for(const[ye,me]of Object.entries(O))if(oe.includes(ye)){p=o[me];break}}if(!p&&!se){console.warn(`‚ö†Ô∏è No inventory data found for format: ${X.name}`);return}let N=0,Z=0;se?["leaderboard","mrec","masthead","interstitial","catfish","in article"].forEach(me=>{const fe=o[me];fe&&(l.length===0||g?(N+=fe.avgMonthlyRequests,Z+=fe.avgMonthlyImpressions):fe.byLanguage.forEach(Oe=>{const Le=Oe.language.toLowerCase();l.some(Se=>Le.includes(Se)||Le.includes("multi"))&&(N+=Oe.totalRequests/12,Z+=Oe.totalImpressions/12)}))}):l.length===0||g?(N=p.avgMonthlyRequests,Z=p.avgMonthlyImpressions):p.byLanguage.forEach(ye=>{const me=ye.language.toLowerCase();l.some(fe=>me.includes(fe)||me.includes("multi"))&&(N+=ye.totalRequests/12,Z+=ye.totalImpressions/12)}),d+=N,b+=Z;const Ve=(N-Z)*.25*f;j.push({name:X.name,avgMonthlyRequests:Math.round(N),avgMonthlyImpressions:Math.round(Z),availableInventory:Math.round(Ve)})});const J=(d-b)*.25*f;return{totalRequests:Math.round(d),totalImpressions:Math.round(b),availableInventory:Math.round(J),formats:j,personaRatio:f}},_a=(s,o,r,f=[],l=1)=>{if(!s||s<=0)return{valid:!0};const w=Aa(o,r,f,l),g=5,d=s/g*1e3,b=w.availableInventory;if(b>0&&d>b*.8){const j=Math.round(b*g/1e3/s*100);if(j<20)return{valid:!1,severity:"critical",message:`Selected formats have insufficient available inventory (${(b/1e6).toFixed(1)}M available). This budget would require ~${(d/1e6).toFixed(1)}M impressions. Please select formats with more inventory or reduce your budget to RM ${Math.round(b*g/1e3/1e3)*1e3}.`,suggestedBudget:Math.round(b*g/1e3/1e3)*1e3,availableImpressions:b,requestedImpressions:d};if(j<50)return{valid:!0,severity:"warning",message:`Limited inventory alert: Selected formats have ~${(b/1e6).toFixed(1)}M available inventory. Consider selecting additional formats with higher inventory for optimal delivery.`,availableImpressions:b,requestedImpressions:d}}return s<2e4?{valid:!0,severity:"info",message:"Budgets under RM 20k may limit the number of channels and formats we can use",availableImpressions:b,requestedImpressions:d}:{valid:!0,availableImpressions:b,requestedImpressions:d}},La={Entertainment:["Entertainment","Comedy Lover","Horror","Romantic Comedy","Action & Adventure","Animation","Sci-Fi & Fantasy","Music & Concert Goers"],Sports:["Sports","EPL Super Fans","Badminton","Golf Fans","Sepak Takraw","Esports Fan"],Lifestyle:["Active Lifestyle Seekers","Adventure Enthusiasts","Health & Wellness Shoppers","Foodies","Travel & Experience Seekers","Fashion Icons"],Technology:["Tech & Gadget Enthusiasts","Gadget Gurus","Online Shoppers"],Automotive:["Automotive Enthusiasts","Automotive Intent"],Business:["Business & Professional","Corporate Visionaries","SME","Start-ups","Emerging Affluents"],Luxury:["Luxury Buyers","Luxury Seekers"],Family:["Family Dynamic ( Experienced Family )","Little Steps Advocates ( Young Family)","Mommy Pros ( Experienced Mother)","Youth Mom","The Dynamic Duo"],"Life Stage":["Students","Young Working Adult","Soloist"],"Home & Living":["Home Buyers","Eco Enthusiasts"]},Pt=s=>{for(const[o,r]of Object.entries(La))if(r.some(f=>s.includes(f)||f.includes(s)))return o;return"Other"},Ma=(s,o)=>{const r=Pt(s),f=Pt(o);return r===f?["Entertainment","Sports"].includes(r)?.75:["Lifestyle","Technology"].includes(r)?.6:.5:r==="Sports"&&f==="Lifestyle"||r==="Lifestyle"&&f==="Sports"?.55:r==="Business"&&f==="Luxury"||r==="Luxury"&&f==="Business"?.45:r==="Entertainment"&&f==="Technology"||r==="Technology"&&f==="Entertainment"||r==="Lifestyle"&&f==="Technology"||r==="Technology"&&f==="Lifestyle"?.3:.25},Pa=(s,o)=>{if(!s||s.length===0)return 0;const r=s.map(l=>o.find(w=>(w.persona||w.name)===l)).filter(Boolean);if(r.length===0)return 0;if(r.length===1)return r[0].totalAudience||0;let f=0;r.forEach(l=>f+=l.totalAudience||0);for(let l=0;l<r.length;l++)for(let w=l+1;w<r.length;w++){const g=Ma(r[l].persona||r[l].name,r[w].persona||r[w].name),d=Math.min(r[l].totalAudience||0,r[w].totalAudience||0);f-=d*g}return Math.max(0,f)},Ra=(s,o)=>{if(!s||s.length===0)return o;const r=s.some(g=>{const d=(g.name||"").toLowerCase(),b=(g.type||"").toLowerCase();return d.includes("social")?!1:b==="video"||d.includes("instream")||d.includes("in-stream")||d.includes("pre-roll")||d.includes("mid-roll")||d.includes("preroll")||d.includes("midroll")}),f=s.some(g=>{const d=(g.name||"").toLowerCase(),b=(g.type||"").toLowerCase();return d.includes("social")?!1:b==="standard iab banner"||b==="high impact"||b==="interactive banner"||d.includes("banner")||d.includes("leaderboard")||d.includes("mrec")||d.includes("masthead")||d.includes("display")}),l=s.some(g=>{const d=(g.name||"").toLowerCase(),b=(g.type||"").toLowerCase();return d.includes("social")||d.includes("stories")||d.includes("story")||d.includes("reel")||d.includes("tiktok")||d.includes("carousel")||d.includes("feed")||d.includes("instagram")||d.includes("facebook")||b==="static image"});console.log("üéØ Smart Channel Filtering:",{hasVideoFormat:r,hasDisplayFormat:f,hasSocialFormat:l});const w={};return Object.entries(o).forEach(([g,d])=>{let b=!1;if(g==="OTT"?b=r:g==="Web"?b=r||f:g==="Social"?b=l:b=!0,b){const j=d.filter(O=>{const F=(O.formats||[]).map(G=>G.toLowerCase());return!!(F.length===0||r&&F.some(G=>G.includes("roll")||G.includes("video"))||f&&F.some(G=>G.includes("banner")||G.includes("leaderboard")||G.includes("mrec")||G.includes("masthead"))||l&&g==="Social")});j.length>0&&(w[g]=j)}}),console.log("‚úÖ Compatible channels:",Object.keys(w)),w},Ta=(s,o)=>{if(!o||o.length===0||["bahasa malaysia","english","chinese"].every(w=>o.some(g=>g.toLowerCase().includes(w.split(" ")[0]))))return s;const l={};return Object.entries(s).forEach(([w,g])=>{if(w==="OTT"||w==="Social"){l[w]=g;return}const d=g.filter(b=>{const j=(b.languages||[]).map(F=>F.toLowerCase());return j.length===0?!0:o.some(F=>{const G=F.toLowerCase();return j.some(J=>J.includes(G)||J.includes("multi"))})});d.length>0&&(l[w]=d)}),console.log("üåç Language-filtered channels:",Object.keys(l)),l},ja=s=>{let o="low",r={};return s<=1e5?(o="low",r={name:"Focused Concentration",maxPlatforms:3,buyingTypes:["Direct"],allowPD:!1,allowPremium:!1,audienceLimit:2,focusStrategy:"single-platform concentration",channelMix:{primary:.6,secondary:.3,tertiary:.1}}):s>1e5&&s<=2e5?(o="mid",r={name:"Balanced Multi-Channel",maxPlatforms:5,buyingTypes:["Direct","PD"],allowPD:!0,allowPremium:!1,audienceLimit:4,focusStrategy:"balanced diversification",channelMix:{primary:.4,secondary:.3,tertiary:.2,quaternary:.1}}):(o="high",r={name:"Premium Diversification",maxPlatforms:6,buyingTypes:["Direct","PD","PG"],allowPD:!0,allowPremium:!0,audienceLimit:6,focusStrategy:"multi-platform premium",channelMix:{primary:.35,secondary:.25,tertiary:.2,quaternary:.12,quinary:.08}}),console.log(`üí∞ BUDGET TIER: ${o.toUpperCase()} (${r.name})`),console.log(`   Max Platforms: ${r.maxPlatforms}, Audience Limit: ${r.audienceLimit}`),{tier:o,strategy:r}},Ia=(s,o,r)=>{const f=new Set(s.map(d=>d.pillar)),l=s.some(d=>d.buyType==="PD"),w=s.some(d=>d.buyType==="PG"),g=[];return o==="high"&&!l&&g.push("‚ö†Ô∏è Strategy warning: High budget should include PD buying type for efficiency"),o==="low"&&(l||w)&&g.push("‚ö†Ô∏è Strategy warning: Low budget should not include PD/PG - stick to Direct for simplicity"),s.length>r.maxPlatforms&&g.push(`‚ö†Ô∏è Platform count (${s.length}) exceeds tier limit (${r.maxPlatforms})`),s.length===r.maxPlatforms&&f.size<2&&g.push("‚ö†Ô∏è Strategy failure: platform mix lacks diversification"),console.log(`‚úÖ TIER VALIDATION: ${g.length===0?"PASSED":g.length+" warnings"}`),g},Ne=(s,o)=>{if(!o||o.length===0||o.includes("Malaysia"))return 1;let r=0,f=s.totalAudience||0;return o.forEach(l=>{const w=s[l];if(w){const g=parseInt(String(w).replace(/,/g,""),10);r+=g||0}}),f>0?r/f:0},We=(s,o)=>{const r=Ne(s,o);return Math.round(r*100)},Tt=(s,o)=>{if(!o||o.length===0||o.includes("Malaysia"))return!1;const r=(s.name||s.site||"").toLowerCase(),f={Penang:["penang","pulau pinang","kwong wah","penang-based"],Johor:["johor","jb","johor bahru","singaporean"],Sabah:["sabah","kota kinabalu","daily express","borneo"],Sarawak:["sarawak","kuching","borneo post","utusan borneo"],Kelantan:["kelantan","kota bharu","kota bahru"],Terengganu:["terengganu","kuala terengganu"],Kedah:["kedah","alor setar"],Perak:["perak","ipoh"],Melaka:["melaka","malacca"],Pahang:["pahang","kuantan"]};for(const l of o)if((f[l]||[]).some(g=>r.includes(g)))return!0;return!1},Ea=(s,o)=>!o||o.length===0||o.includes("Malaysia")?1:Tt(s,o)?2:.5,$a=(s,o)=>{var J,X,oe;const{campaign_objective:r,industry:f,budget_rm:l,devices:w=[],creative_asset_type:g}=o,d=at(f),b=(J=ke.verticals)==null?void 0:J[d],O={Awareness:"awareness",VideoView:"awareness",Traffic:"consideration",Engagement:"consideration",LeadGen:"conversion",Conversion:"conversion"}[r]||"awareness",F=((X=b==null?void 0:b.funnel)==null?void 0:X[O])||[],G=((oe=b==null?void 0:b.creative_requirements)==null?void 0:oe.best_formats)||[];return s.map(H=>{let K=50,p=[];(F.includes(H.name)||F.includes(H["Ad Format"]))&&(K+=30,p.push(`Recommended for ${O} in ${f}`)),(G.includes(H.name)||G.includes(H["Ad Format"]))&&(K+=15,p.push("Top performer for this vertical"));const N=(H.name||H["Ad Format"]||"").toLowerCase();return r==="Awareness"||r==="VideoView"?(N.includes("video")||N.includes("masthead")||N.includes("takeover"))&&(K+=20,p.push("High visibility for awareness goals")):r==="LeadGen"?(N.includes("lead")||N.includes("form")||N.includes("native"))&&(K+=20,p.push("Optimized for lead capture")):r==="Traffic"&&(N.includes("banner")||N.includes("native")||N.includes("display"))&&(K+=20,p.push("Cost-effective for driving traffic")),g==="video"&&N.includes("video")?(K+=15,p.push("Matches your video creative")):g==="static"&&(N.includes("banner")||N.includes("display"))&&(K+=15,p.push("Matches your static creative")),w.includes("Mobile")&&(N.includes("mobile")||N.includes("vertical"))&&(K+=10,p.push("Mobile-optimized")),l<1e5?((N.includes("banner")||N.includes("display"))&&(K+=10,p.push("Cost-efficient for your budget")),(N.includes("takeover")||N.includes("masthead"))&&(K-=20,p.push("‚ö†Ô∏è May be too premium for budget"))):l>2e5&&(N.includes("takeover")||N.includes("masthead")||N.includes("premium"))&&(K+=15,p.push("Premium format appropriate for budget")),K=Math.min(100,Math.max(0,K)),{...H,confidence:Math.round(K),reason:p.join(" ‚Ä¢ "),_reasons:p}}).sort((H,K)=>K.confidence-H.confidence)},Na=(s,o,r=[])=>{const{campaign_objective:f,industry:l,geography:w=[],audience:g,budget_rm:d}=o;at(l);const b=Array.isArray(w)?w:w?[w]:[];return s.map(j=>{let O=50,F=[];const G=j.category||j.Category||"";r.map(se=>(se.category||se.Category||"").toLowerCase()).some(se=>G.toLowerCase().includes(se))&&(O+=20,F.push("Matches selected formats"));const X=j.monthlyTraffic||j["Total impressions"]||0;X>1e7?(O+=15,F.push("High traffic premium publisher")):X>5e6&&(O+=10,F.push("Strong reach"));const oe=(j.name||j.siteName||j.Property||"").toLowerCase(),H=oe.includes("malaysia")||oe.includes("national");b.includes("Malaysia")&&H&&(O+=10,F.push("National coverage")),b.forEach(se=>{const N=(se||"").toString().toLowerCase();oe.includes(N)&&(O+=15,F.push(`Strong ${se} presence`))});const K=(j.industry||"").toLowerCase(),p=(l||"").toLowerCase();return K&&p&&K.includes(p)&&(O+=15,F.push("Industry-relevant audience")),O=Math.min(100,Math.max(0,O)),{...j,confidence:Math.round(O),reason:F.join(" ‚Ä¢ "),_reasons:F}}).sort((j,O)=>O.confidence-j.confidence)},Da=(s,o)=>{const{campaign_objective:r,industry:f,budget_rm:l,duration_weeks:w,budgetTier:g}=s,d=[];return g==="low"?d.push({title:"Focused Concentration Strategy",description:"Concentrate budget on 2-3 high-performing channels for maximum impact",tactics:["Start with Direct buys for cost efficiency","Focus on 2 core audience segments","Use cost-effective display and native formats","Run for minimum 4 weeks for learning phase"],expectedOutcome:"Maximize reach within budget constraints while maintaining quality placements"}):g==="mid"?d.push({title:"Balanced Multi-Channel Strategy",description:"Diversify across 4-5 channels with mix of Direct and PD buys",tactics:["Mix Direct (60%) and PD (40%) for balance","Target 3-4 complementary audience segments","Combine video and display for format diversity","Include at least one premium site for brand lift"],expectedOutcome:"Balanced reach and frequency with good cost efficiency and brand safety"}):g==="high"&&d.push({title:"Premium Diversification Strategy",description:"Full-funnel approach with premium placements and optimization",tactics:["Enable PD and Premium buys for maximum reach","Target 5-6 audience segments across funnel","Include high-impact formats (Masthead, Takeover)","Add OTT for premium video exposure","Reserve 20% budget for mid-flight optimization"],expectedOutcome:"Maximum reach, brand lift, and performance with full optimization flexibility"}),r==="Awareness"||r==="VideoView"?d.push({title:"Awareness Maximization",description:"Optimize for maximum unique reach and brand exposure",tactics:["Prioritize video formats for engagement","Target broad, high-reach audiences","Use frequency capping (3-5 per user)","Mix premium and scale inventory","Measure brand lift via surveys"],kpis:["Unique Reach","Video Completion Rate","Brand Awareness Lift"]}):r==="LeadGen"?d.push({title:"Lead Generation Optimization",description:"Drive qualified leads with clear CTAs and forms",tactics:["Use lead form and native article formats","Target in-market audiences with intent signals","A/B test different value propositions","Optimize for CPL (Cost Per Lead)","Implement lead verification"],kpis:["Leads Generated","CPL","Lead Quality Score","Conversion Rate"]}):r==="Traffic"&&d.push({title:"Traffic & Engagement Optimization",description:"Drive qualified site traffic with strong CTAs",tactics:["Use banner, native, and carousel formats","Target audiences with high CTR history","Optimize for CPC (Cost Per Click)","Use retargeting for repeat visitors","Track on-site engagement metrics"],kpis:["Clicks","CTR","CPC","Landing Page Views","Bounce Rate"]}),d.push({title:"Pacing & Optimization",description:"Smart budget pacing with continuous optimization",tactics:[w>=4?"Week 1-2: Learning phase, gather data":"Week 1: Fast learning phase",w>=4?"Week 3: Optimize based on early signals":"Week 2: Quick optimization",w>=4?"Week 4+: Scale winners, pause underperformers":"End: Final push on best performers","Daily budget pacing to avoid overspend","Reserve 15-20% for mid-flight reallocation"],expectedOutcome:"Efficient budget utilization with continuous performance improvement"}),d},at=s=>{var f;if(!s)return null;const o=s.toLowerCase().replace(/[^a-z0-9]/g,"_");if((f=ke.verticals)!=null&&f[o])return o;const r=Object.keys(ke.verticals||{});for(const l of r)if(l.includes(o)||o.includes(l))return l;return o},Oa=(s,o)=>{var b;const{campaign_objective:r,industry:f}=o,l=at(f),w=(b=ke.performance_benchmarks)==null?void 0:b[l];if(!w)return s;let g="awareness";r==="LeadGen"?g="leads":r==="Traffic"?g="traffic":r==="Conversion"&&(g="sales");const d=w[g];return d?s.map(j=>{const O=(j.name||"").toLowerCase();let F={...j};return Object.entries(d).forEach(([G,J])=>{O.includes(G.replace("_"," "))&&(F.benchmarks={ctr:J.expected_ctr?`${(J.expected_ctr*100).toFixed(2)}%`:null,vtr:J.expected_vtr?`${(J.expected_vtr*100).toFixed(0)}%`:null,avgCpm:J.avg_cpm_rm?`RM ${J.avg_cpm_rm}`:null},F.reason=`${F.reason} ‚Ä¢ Industry avg CTR: ${F.benchmarks.ctr||"N/A"}`)}),F}):s},Rt={january:0,jan:0,february:1,feb:1,march:2,mar:2,april:3,apr:3,may:4,june:5,jun:5,july:6,jul:7,august:8,aug:8,september:9,sept:9,sep:9,october:10,oct:10,november:11,nov:11,december:12,dec:12},Fa=s=>{if(!s||typeof s!="string")return{startDate:null,endDate:null,durationWeeks:null,confidence:0,parsed:!1};const o=s.toLowerCase().trim(),r=new Date().getFullYear(),f=[];if(Object.keys(Rt).forEach(Z=>{const pe=new RegExp(`\\b${Z}\\b`,"gi");o.match(pe)&&f.push({month:Rt[Z],name:Z,index:o.indexOf(Z.toLowerCase())})}),f.length===0)return{startDate:null,endDate:null,durationWeeks:null,confidence:0,parsed:!1};f.sort((Z,pe)=>Z.index-pe.index);let l,w;f.length>=2?(l=f[0].month,w=f[f.length-1].month):(l=f[0].month,w=l);let g=1,d=28;const b=o.match(/(\d{1,2})\s*(?:march|mar|april|apr|may|june|jun|july|jul|august|aug|september|sept|sep|october|oct|november|nov|december|dec|january|jan|february|feb)|(?:march|mar|april|apr|may|june|jun|july|jul|august|aug|september|sept|sep|october|oct|november|nov|december|dec|january|jan|february|feb)\s*(\d{1,2})/i);if(b){const Z=parseInt(b[1]||b[2]);Z>=1&&Z<=31&&(g=Z)}else/(early|start|beginning)/.test(o)?g=1:/mid/.test(o)?g=15:/(late|end)/.test(o)&&(g=21);if(f.length>=2){const Z=o.substring(f[1].index);/(early|start|beginning)/.test(Z)?d=7:/mid/.test(Z)?d=15:/(late|end)/.test(Z)&&(d=28)}else d=28;const j=new Date,O=j.getMonth(),F=j.getDate();let G=r,J=r;(l<O||l===O&&g<F)&&(G=r+1,J=r+1),w<l&&(J=G+1);const X=new Date(G,l,g),oe=new Date(J,w,d);let H=oe-X,K=Math.max(1,Math.floor(H/(1e3*60*60*24))),p=Math.max(1,Math.round(K/7));const se=o.match(/(\d{1,3})\s*(?:week|wk|weeks|wks)/i);if(se){const Z=parseInt(se[1]);if(Z>=1&&Z<=52){p=Z;const pe=new Date(X);return pe.setDate(pe.getDate()+p*7),{startDate:X.toISOString().split("T")[0],endDate:pe.toISOString().split("T")[0],durationWeeks:p,confidence:90,parsed:!0,rawInput:s}}}let N=50;return f.length>=2&&(N+=30),/(mid|early|late|start|end|beginning)/.test(o)&&(N+=20),{startDate:X.toISOString().split("T")[0],endDate:oe.toISOString().split("T")[0],durationWeeks:p,confidence:Math.min(100,N),parsed:!0,rawInput:s}};function qa(){ca();const[s,o]=z.useState([]),[r,f]=z.useState(""),[l,w]=z.useState(!1),[g,d]=z.useState(null),[b,j]=z.useState(""),{sendMessage:O,cancelRequest:F}=fa(),G=z.useRef({rates:[],formats:[],audiences:[],sites:[]}),J=z.useRef(null),X=z.useRef(!1),oe=z.useRef(Date.now().toString()),[H,K]=z.useState({campaignName:null,product_brand:null,campaign_objective:null,industry:null,startDate:null,budget_rm:null,geography:[],audience:null,duration_weeks:null,devices:[],buying_type:null,priority:null,channel_preference:null,creative_assets:null,geography_specificity:null,buying_preference:null,_extractionLog:[],_budgetAsked:!1,_needsBudgetSuggestion:!1,_budgetSuggested:!1,_showingTiers:!1,_contextGatheringPhase:"initial",_contextQuestionsAsked:{creative_assets:!1,duration:!1,geography_specificity:!1,buying_preference:!1}}),[p,se]=z.useState(null),[N,Z]=z.useState(!1),pe=z.useRef(null),Te=z.useRef(!1),[Ve,ye]=z.useState(!1),[me,fe]=z.useState(""),[Oe,Le]=z.useState([]),[Se,nt]=z.useState({}),[st,ot]=z.useState(null),[be,Ie]=z.useState({}),[jt,rt]=z.useState(null),[It,ze]=z.useState(!1),[Fe,He]=z.useState({blacklist:[],whitelist:[]}),Et=(n,e)=>{console.log(`üìù [PANEL EDIT] Updating ${n} to:`,e),K(c=>({...c,[n]:e}))},[Ae,$t]=z.useState({rates:[],formats:[],audiences:[],sites:[]}),[Nt,Dt]=z.useState({}),Ot=()=>{var n;(n=pe.current)==null||n.scrollIntoView({behavior:"smooth"})};z.useEffect(()=>{Ot()},[s]),z.useEffect(()=>{if(s.length>0){const n={messages:s,brief:H,timestamp:new Date().toISOString(),recommendations:p};localStorage.setItem("ai_wizard_conversation",JSON.stringify(n)),console.log("üíæ [AUTO-SAVE] Conversation saved to localStorage")}},[s,H,p]),z.useEffect(()=>{const n=localStorage.getItem("ai_wizard_conversation");if(n&&!Te.current)try{const e=JSON.parse(n),c=new Date(e.timestamp),v=(new Date-c)/(1e3*60*60);if(v<24&&e.messages.length>0){const k=e.messages.map(h=>({...h,timestamp:h.timestamp?new Date(h.timestamp):new Date}));o(k),K(e.brief||{}),se(e.recommendations||null),Te.current=!0,console.log(`‚úÖ [AUTO-RESTORE] Restored conversation from ${v.toFixed(1)}h ago`);return}}catch(e){console.error("‚ùå [AUTO-RESTORE] Failed to restore conversation:",e),localStorage.removeItem("ai_wizard_conversation")}},[]),z.useEffect(()=>{!l&&J.current&&setTimeout(()=>{var n;(n=J.current)==null||n.focus()},100)},[l]),z.useEffect(()=>{console.log("üöÄ AI Wizard v2.1 - Entity Extraction Enhanced"),console.log("üì¶ Initial datasets state:",Ae),Ft(),Te.current||(Te.current=!0,Y("assistant","What's your campaign name?",{currentStep:0,showActions:!1}))},[]),z.useEffect(()=>{console.log("üîÑ Datasets state changed:",{rates:Ae.rates.length,formats:Ae.formats.length,audiences:Ae.audiences.length,sites:Ae.sites.length})},[Ae]);const Ft=async()=>{var n;try{console.log("üîÑ [FAST-LOAD] Loading datasets in background...");const[e,c,u,v]=await Promise.all([de.get("/api/rates").catch(()=>({data:{data:[]}})),de.get("/api/formats").catch(()=>({data:{data:[]}})),de.get("/api/audience").catch(()=>({data:{data:[]}})),de.get("/api/inventory").catch(()=>({data:{data:[]}}))]);console.log("‚úÖ [FAST-LOAD] API responses received"),setTimeout(()=>{console.log("üîÑ [FAST-LOAD] Processing data...");let k=[];try{k=(u.data.data||[]).map(_=>{const y=Object.keys(_).filter(A=>A!=="Personas"&&A!=="Industry Interests"&&A!=="id").reduce((A,C)=>{try{const U=String(_[C]||"0").replace(/,/g,""),R=parseInt(U);return A+(isNaN(R)?0:R)}catch{return A}},0),S=_["Industry Interests"]||"",re=S?S.split(",").map(A=>A.trim()).filter(A=>A):[];return{persona:_.Personas||"Unknown Audience",totalAudience:y,interests:re,..._}})}catch(_){console.error("‚ö†Ô∏è Error transforming audiences:",_),k=u.data.data||[]}let h=[];try{const _=new Map;(v.data.data||[]).forEach(Q=>{const y=Q.IP||Q.Entity||"Unknown Site",S=Q.Property||"Web",re=parseInt(Q["Total impressions"])||0;_.has(y)?_.get(y).monthlyTraffic+=re:_.set(y,{name:y,category:S,monthlyTraffic:re,entity:Q.Entity})}),h=Array.from(_.values())}catch(_){console.error("‚ö†Ô∏è Error transforming sites:",_),h=v.data.data||[]}const I={rates:e.data.data||[],formats:c.data.data||[],audiences:k,sites:h};console.log("‚úÖ [FAST-LOAD] Datasets processed:",{rates:I.rates.length,formats:I.formats.length,audiences:I.audiences.length,sites:I.sites.length}),$t(I),G.current=I,console.log("‚úÖ [FAST-LOAD] Datasets state updated"),de.get("/api/inventory/by-format").then(_=>{if(_.data.success&&_.data.formats){const Q={};_.data.formats.forEach(y=>{const S=y.formatName.toLowerCase();Q[S]={avgMonthlyRequests:y.avgMonthlyRequests,avgMonthlyImpressions:y.avgMonthlyImpressions,byLanguage:y.byLanguage,byProperty:y.byProperty}}),Dt(Q),console.log("‚úÖ [FAST-LOAD] Format inventory loaded")}}).catch(_=>console.warn("‚ö†Ô∏è Format inventory skipped:",_.message))},0)}catch(e){console.error("‚ùå Error loading datasets:",e),console.error("‚ùå Error details:",e.message,(n=e.response)==null?void 0:n.status)}},Y=(n,e,c=null)=>{o(u=>[...u,{role:n,content:e,data:c,timestamp:new Date}])},it=n=>{const e=n.toLowerCase(),c=ke.vertical_playbook;for(const[u,v]of Object.entries(c))if(v.aliases&&Array.isArray(v.aliases)){for(const k of v.aliases)if(e.includes(k.toLowerCase().replace(/_/g," ")))return console.log(`[TARGET] Matched vertical: ${v.label} (key: ${u})`),u}return null},Bt=n=>{if(!n)return null;const e=ke.vertical_playbook;if(e[n])return e[n];for(const[c,u]of Object.entries(e))if(u.label.toLowerCase().includes(n.toLowerCase()))return u;return null},Ue=n=>({Awareness:"awareness",VideoView:"awareness",Consideration:"consideration",Engagement:"consideration",Traffic:"conversion",LeadGen:"conversion",Conversion:"conversion"})[n]||"awareness",Gt=(n=null)=>{const e=n||H,c={};return(!e.geography||e.geography.length===0)&&(c.geography=["Malaysia"]),(!e.devices||e.devices.length===0)&&(e.campaign_objective==="VideoView"&&e.budget_rm>1e5?c.devices=["CTV","Mobile","Desktop"]:e.industry==="FMCG"||e.industry==="Retail"?c.devices=["Mobile","Desktop"]:e.industry==="Banking"||e.industry==="Property"?c.devices=["Desktop","Mobile"]:c.devices=["Mobile","Desktop"]),e.buying_type||(c.buying_type="Mixed"),e.priority||(e.campaign_objective==="Awareness"||e.campaign_objective==="VideoView"?c.priority="Max Reach":e.campaign_objective==="LeadGen"||e.campaign_objective==="Traffic"?c.priority="Performance":c.priority="Balanced"),e.duration_weeks||(c.duration_weeks=4),{...e,...c}},Wt=(n=null)=>{var wt,Ct,xt,kt,St,At,_t;const e=G.current;if(!e.rates.length||!e.formats.length)return console.error("‚ùå Datasets not loaded yet",{rates:e.rates.length,formats:e.formats.length}),null;const c=n||H;console.log("üìã Using brief for plan generation:",c);const u=Gt(c),{campaign_objective:v,industry:k,budget_rm:h,devices:I,buying_type:_,priority:Q,geography:y,duration_weeks:S,audience:re}=u,{tier:A,strategy:C}=ja(h);console.log(`[BUDGET] BUDGET TIER DETERMINED: ${A.toUpperCase()} (${C.name})`),console.log(`   Budget: RM ${h.toLocaleString()}`),console.log(`   Max Platforms: ${C.maxPlatforms}`),console.log(`   Audience Limit: ${C.audienceLimit}`),console.log(`   Buying Types: ${C.buyingTypes.join(", ")}`);const U=Sa(u.selectedPersonas||[],e.audiences,u.massTargeting||!1);console.log("[TARGET] PLAYBOOK Format selection - Objective:",v,"| Industry:",k);let R=[];const ue=c._vertical_key||De(k),Me=ya(ue,ke)||ba(),m=Me.config,L=Me.source,q=Me.label;if(console.log(`üìñ PLAYBOOK SOURCE: ${L.toUpperCase()}`),console.log(`   Industry Key: ${ue} ‚Üí Playbook: ${q}`),m){console.log(`   Strategy DNA: ${m.strategy_dna}`);const t=Ue(v);console.log(`   Funnel stage: ${t} (from ${v})`);const i=m.funnel[t]||[],x=((wt=m.creative_requirements)==null?void 0:wt.best_formats)||[],T=[...i,...x];if(console.log("   Playbook recommends:",T),R=e.formats.filter(M=>{const D=(M.name||M["Ad format"]||"").toLowerCase(),ee=(M.goal||"").toLowerCase();return T.some(le=>le.toLowerCase().replace(/_/g," ").split(/[\s_]+/).some(ne=>D.includes(ne)||ee.includes(ne)))}),R.length<3){if(console.log("   ‚ö†Ô∏è Limited matches, applying format type rules"),t==="awareness"){const M=e.formats.filter(D=>(D.name||D["Ad format"]||"").toLowerCase().match(/video|stream|ott|ctv/i));R.push(...M)}else if(t==="consideration"){const M=e.formats.filter(D=>(D.name||D["Ad format"]||"").toLowerCase().match(/rich|interactive|carousel|calculator|collector/i));R.push(...M)}else{const M=e.formats.filter(D=>(D.name||D["Ad format"]||"").toLowerCase().match(/display|banner|native|retarget|lead/i));R.push(...M)}R=[...new Map(R.map(M=>[M.id||M.name,M])).values()]}console.log(`   ‚úÖ Selected ${R.length} formats from playbook`)}else console.log("‚ö†Ô∏è No playbook found, using generic selection"),R=e.formats.filter(t=>(t.goal||"").toLowerCase().includes(v.toLowerCase()));const ae=c._seasonalContext,B=c._culturalContext;if(ae||B){console.log("üéä SEASONAL/CULTURAL OVERRIDE: Replacing standard formats with festive-optimized selection"),console.log(`   Seasonal: ${ae}, Cultural: ${B}`);const t=["video","ott","ctv","streaming","hero","billboard","takeover","carousel","interactive","rich media","native","branded content","editorial","social"],i=e.formats.filter(x=>{const T=(x.name||x["Ad format"]||"").toLowerCase(),M=(x.goal||"").toLowerCase();return t.some(D=>T.includes(D)||M.includes(D))});i.length>=4?(R=i,console.log(`   ‚úÖ Replaced with ${i.length} festive-optimized formats`)):(R=[...i,...R.filter(x=>!i.includes(x))],console.log(`   ‚ö†Ô∏è Limited festive formats (${i.length}), mixed with standard`))}const $=u.channel_preference;if($&&$!=="Balanced"){console.log(`üì∫ Channel preference: ${$} - Filtering formats`);let t=[];if($==="OTT"?(t=R.filter(i=>(i.name||i["Ad format"]||"").toLowerCase().match(/stream|video|ott|ctv|youtube|viu|iflix|astro/i)),console.log(`   Found ${t.length} OTT/Streaming formats`)):$==="Social"?(t=R.filter(i=>{const x=(i.name||i["Ad format"]||"").toLowerCase(),T=(i.platform||"").toLowerCase();return x.match(/social|facebook|instagram|tiktok|meta|feed|story|reel/i)||T.match(/social|facebook|instagram|tiktok|meta/i)}),console.log(`   Found ${t.length} Social Media formats`)):$==="Display"&&(t=R.filter(i=>(i.name||i["Ad format"]||"").toLowerCase().match(/display|banner|native|leaderboard|mrec|skyscraper|programmatic/i)),console.log(`   Found ${t.length} Display formats`)),t.length>=3)R=t,console.log(`   ‚úÖ Prioritizing ${$} formats`);else{const i=R.filter(x=>!t.includes(x));R=[...t,...i],console.log(`   ‚ö†Ô∏è Limited ${$} formats, mixing with others`)}}R=R.slice(0,Math.min(6,Math.max(4,R.length))),R.length===0&&(console.log("‚ö†Ô∏è No match - using top formats as fallback"),R=e.formats.slice(0,5)),console.log("üîç Validating inventory capacity...");const ie=_a(h,R,Nt,u.targetLanguages||[],U);ie.valid?ie.severity&&console.log(`‚ÑπÔ∏è Inventory notice (${ie.severity}):`,ie.message):console.warn("‚ö†Ô∏è INVENTORY WARNING:",ie.message),console.log(`‚úÖ PLAYBOOK APPLIED: ${q} (source: ${L})`),console.log(`   Objective: ${v} ‚Üí Funnel: ${Ue(v)}`),console.log(`   Selected ${R.length} formats:`,R.map(t=>t.name||t["Ad format"]).join(", ")),L==="generic"&&console.log(`   ‚ö†Ô∏è WARNING: Using generic fallback - no industry-specific playbook found for ${k}`);let ve=e.rates.filter(t=>{const i=(t.Devices||"").toLowerCase();return I.some(x=>i.includes(x.toLowerCase()))}).map(t=>{let i=999,x=_;if(_==="Direct")i=parseFloat(t["CPM Direct (RM)"])||999;else if(_==="PG")i=parseFloat(t["CPM PG (RM)"])||parseFloat(t["CPM Direct (RM)"])||999;else if(_==="PD")i=parseFloat(t["CPM PD (RM)"])||parseFloat(t["CPM PG (RM)"])||parseFloat(t["CPM Direct (RM)"])||999;else{const T=parseFloat(t["CPM PD (RM)"])||999,M=parseFloat(t["CPM PG (RM)"])||999,D=parseFloat(t["CPM Direct (RM)"])||999;i=Math.min(T,M,D),i===T&&T<999?x="PD":i===M&&M<999?x="PG":i===D&&D<999&&(x="Direct")}return{...t,selectedCPM:i,actualBuyType:x}}).filter(t=>t.selectedCPM<999);ve.length===0&&(ve=e.rates.map(t=>{const i=parseFloat(t["CPM PD (RM)"])||999,x=parseFloat(t["CPM PG (RM)"])||999,T=parseFloat(t["CPM Direct (RM)"])||999,M=Math.min(i,x,T);let D="Mixed";return M===i&&i<999?D="PD":M===x&&x<999?D="PG":M===T&&T<999&&(D="Direct"),{...t,selectedCPM:M,actualBuyType:D}}).filter(t=>t.selectedCPM<999)),ve.sort((t,i)=>Q==="Max Reach"?t.selectedCPM-i.selectedCPM:Q==="Performance"?i.selectedCPM-t.selectedCPM:0);const we=ve.slice(0,6);console.log("[TARGET] Applying intelligent format scoring...");const Ee=$a(R,{campaign_objective:v,industry:k,budget_rm:h,devices:u.devices||[],creative_asset_type:u.creative_asset_type}),Pe=Oa(Ee,{campaign_objective:v,industry:k});R=Pe.slice(0,Math.min(6,Pe.length)),console.log(`‚úÖ Scored formats - Top format: ${(Ct=R[0])==null?void 0:Ct.name} (${(xt=R[0])==null?void 0:xt.confidence}% confidence)`),console.log("üë• Total audiences available:",e.audiences.length);let E=[];const $e=c._contextPersonas||[];if($e.length>0||ae||B){if(console.log("[TARGET] CONTEXT-AWARE: Using product/seasonal/cultural personas"),console.log("   Context personas:",$e),ae&&console.log(`   Seasonal: ${ae}`),B&&console.log(`   Cultural: ${B}`),E=e.audiences.filter(i=>{const x=(i.persona||i.name||"").toLowerCase();return $e.some(T=>{const M=T.toLowerCase();return M.split(/\s+/).some(ee=>x.includes(ee))||x.includes(M)})}).sort((i,x)=>(x.totalAudience||0)-(i.totalAudience||0)).slice(0,C.audienceLimit),console.log(`‚úÖ Context-matched audiences: ${E.length} (limit: ${C.audienceLimit})`),E.length<C.audienceLimit){const i=e.audiences.filter(x=>!E.includes(x)).sort((x,T)=>(T.totalAudience||0)-(x.totalAudience||0));E.push(...i.slice(0,C.audienceLimit-E.length))}}else{const t=c._vertical_key||De(k),i=Me.personas;if(i&&i.primary_personas&&i.primary_personas.length>0){console.log(`üìñ Using persona mapping for ${t} (${L} playbook)`),console.log("   Primary personas:",i.primary_personas);const x=e.audiences.filter(te=>{const V=(te.persona||te.name||"").toLowerCase();return Fe.blacklist.some(ne=>V.includes(ne.toLowerCase())||ne.toLowerCase().includes(V.split(" ")[0]))?(console.log("[PERSONA] Filtered out blacklisted:",V),!1):i.primary_personas.some(ne=>{const _e=ne.toLowerCase();return _e.split(/\s+/).some(et=>V.includes(et))||V.includes(_e)})}),T=e.audiences.filter(te=>{const V=(te.persona||te.name||"").toLowerCase();return Fe.blacklist.some(ne=>V.includes(ne.toLowerCase())||ne.toLowerCase().includes(V.split(" ")[0]))?(console.log("[PERSONA] Filtered out blacklisted:",V),!1):i.secondary_personas.some(ne=>{const _e=ne.toLowerCase();return _e.split(/\s+/).some(et=>V.includes(et))||V.includes(_e)})}),M=x.map(te=>({...te,geoScore:Ne(te,y),geoRelevance:We(te,y)})).sort((te,V)=>V.geoScore-te.geoScore),D=T.map(te=>({...te,geoScore:Ne(te,y),geoRelevance:We(te,y)})).sort((te,V)=>V.geoScore-te.geoScore),ee=Math.max(1,Math.floor(C.audienceLimit*.75)),le=C.audienceLimit-ee;if(E=[...M.slice(0,ee),...D.slice(0,le)],E.length<C.audienceLimit){const te=e.audiences.filter(V=>!E.includes(V)).map(V=>({...V,geoScore:Ne(V,y),geoRelevance:We(V,y)})).sort((V,ne)=>ne.geoScore-V.geoScore);E.push(...te.slice(0,C.audienceLimit-E.length))}console.log(`‚úÖ Persona-mapped audiences: ${E.length} (limit: ${C.audienceLimit})`),y&&y.length>0&&!y.includes("Malaysia")&&(console.log(`   üåç Geo-weighted for: ${y.join(", ")}`),console.log(`   Top audience geo-relevance: ${((kt=E[0])==null?void 0:kt.geoRelevance)||"N/A"}%`)),Fe.whitelist.length>0&&e.audiences.filter(V=>{const ne=(V.persona||V.name||"").toLowerCase();return Fe.whitelist.some(_e=>ne.includes(_e.toLowerCase())||_e.toLowerCase().includes(ne.split(" ")[0]))}).forEach(V=>{E.find(ne=>(ne.persona||ne.name)===(V.persona||V.name))||(E.length>=C.audienceLimit&&E.pop(),E.push(V),console.log("[PERSONA] Force-included whitelisted:",V.persona||V.name))})}else if(Ca(t)){const T=xa(t);console.log(`‚ö†Ô∏è No persona mapping, but ${t} is CRITICAL-FIT industry`),console.log("   Using fallback whitelist:",T),E=e.audiences.filter(M=>{const D=(M.persona||M.name||"").toLowerCase();return T.some(ee=>{const le=ee.toLowerCase();return le.split(/\s+/).some(V=>D.includes(V))||D.includes(le)})}),E=E.map(M=>({...M,geoScore:Ne(M,y),geoRelevance:We(M,y)})),E.sort((M,D)=>D.geoScore-M.geoScore),E=E.slice(0,C.audienceLimit),console.log(`   ‚úÖ Selected ${E.length} strategic-fit audiences`)}else console.log("‚ö†Ô∏è No persona mapping, using industry interest matching"),E=e.audiences.filter(T=>T.interests&&T.interests.some(D=>D&&D.toLowerCase().includes(k.toLowerCase()))).sort((T,M)=>(M.totalAudience||0)-(T.totalAudience||0)).slice(0,C.audienceLimit),E.length===0&&(console.log("‚ö†Ô∏è No audiences matched industry, falling back to top audiences by reach"),console.log("   ‚ö†Ô∏è This fallback is acceptable for non-critical industries"),E=e.audiences.sort((T,M)=>(M.totalAudience||0)-(T.totalAudience||0)).slice(0,C.audienceLimit))}E.sort((t,i)=>(i.totalAudience||0)-(t.totalAudience||0)),E=E.slice(0,C.audienceLimit),console.log(`‚úÖ FINAL AUDIENCES: ${E.length} (tier limit: ${C.audienceLimit})`);const Be=E.map(t=>t.persona||t.name),Ce=Pa(Be,e.audiences),W=E.reduce((t,i)=>t+(i.totalAudience||0),0),he=W-Ce;console.log("üìä UNIQUE REACH CALCULATION:"),console.log(`   Simple sum: ${W.toLocaleString()}`),console.log(`   Unique reach: ${Ce.toLocaleString()}`),console.log(`   Overlap reduction: ${he.toLocaleString()} (${(he/W*100).toFixed(1)}%)`),console.log("‚úÖ Final selected audiences:",E.length,E.map(t=>t.persona||t.name)),console.log("üåê Total sites available:",e.sites.length);let P=[];if(ae||B){console.log("üéä SEASONAL/CULTURAL SITE SELECTION: Prioritizing vernacular publishers");const i=B?{malay:["malay","melayu","utusan","berita","harian","sinar","malaysia","astro"],chinese:["chinese","mandarin","sina","oriental","nanyang","star","kwong wah","china press"],indian:["tamil","hindu","malaysia nanban","makkal osai"],sabah_sarawak:["borneo","sarawak","sabah","daily express","utusan borneo"]}[B]||[]:[],x=e.sites.filter(ee=>{const le=(ee.name||ee.site||"").toLowerCase();return i.some(te=>le.includes(te))}),T=["astro","tonton","ott","tv","streaming","media","news"],M=e.sites.filter(ee=>{const le=(ee.name||ee.site||"").toLowerCase();return T.some(te=>le.includes(te))&&!x.includes(ee)}),D=e.sites.filter(ee=>!x.includes(ee)&&!M.includes(ee)).sort((ee,le)=>(le.monthlyTraffic||0)-(ee.monthlyTraffic||0));P=[...x.slice(0,B?3:0),...M.slice(0,2),...D].slice(0,5),console.log(`   ‚úÖ Vernacular sites: ${x.length}, Premium: ${M.length}`),console.log(`   Selected mix: ${P.length} sites for ${B||"festive"} campaign`)}else if(y&&y.length>0&&!y.includes("Malaysia")){console.log(`üåê Geo-aware site selection for regional campaign: ${y.join(", ")}`);const t=e.sites.map(x=>({...x,geoScore:Ea(x,y),isRegional:Tt(x,y)}));t.sort((x,T)=>x.isRegional!==T.isRegional?T.isRegional-x.isRegional:(T.monthlyTraffic||0)*T.geoScore-(x.monthlyTraffic||0)*x.geoScore),P=t.slice(0,5);const i=P.filter(x=>x.isRegional).length;console.log(`   ‚úÖ Selected ${i} regional sites out of ${P.length}`)}else P=e.sites.sort((t,i)=>(i.monthlyTraffic||0)-(t.monthlyTraffic||0)).slice(0,5);Array.isArray(P)||(console.warn("‚ö†Ô∏è selectedSites is not an array:",typeof P,P),P=[]),P=P.map(t=>typeof t=="string"?(console.warn("‚ö†Ô∏è Site is a string, converting:",t),{name:t,siteName:t,category:"Web",monthlyTraffic:0}):!t||typeof t!="object"?(console.warn("‚ö†Ô∏è Invalid site entry:",t),null):{...t,name:t.name||t.siteName||t.Property||"Unknown",siteName:t.siteName||t.name||t.Property||"Unknown",category:t.category||t.Category||"Web",monthlyTraffic:t.monthlyTraffic||t["Total impressions"]||0}).filter(t=>t!==null),console.log("‚úÖ Selected sites (normalized):",P.length,P.map(t=>t.name));const ce={};P.forEach(t=>{const i=t.category||"Web";ce[i]||(ce[i]=[]),ce[i].push(t)}),console.log("[TARGET] Applying format-site compatibility filtering...");const Re=Ra(R,ce);if(P=Object.values(Re).flat().filter(t=>t&&typeof t=="object"),Array.isArray(P)||(console.error("‚ùå selectedSites became non-array after flattening:",typeof P),P=[]),console.log(`‚úÖ Compatible sites after format filtering: ${P.length}`),u.targetLanguages&&u.targetLanguages.length>0){console.log("üåç Applying language filtering...");const t=Ta({Web:P.filter(i=>i.category==="Web"||!i.category),OTT:P.filter(i=>i.category==="OTT"),Social:P.filter(i=>i.category==="Social")},u.targetLanguages);P=Object.values(t).flat().filter(i=>i&&typeof i=="object"),Array.isArray(P)||(console.error("‚ùå selectedSites became non-array after language filtering"),P=[]),console.log(`‚úÖ Sites after language filtering: ${P.length}`)}if(Array.isArray(P)||(console.error("‚ùå CRITICAL: selectedSites is not an array before scoring!",typeof P),P=[]),P.length===0)return console.warn("‚ö†Ô∏è No sites available for scoring, cannot generate plan"),null;console.log("[TARGET] Applying intelligent site scoring...");const pt=Na(P,{campaign_objective:v,industry:k,geography:u.geography||[],audience:E,budget_rm:h},R),qe=pt.slice(0,10);console.log(`‚úÖ Scored sites - Top site: ${((St=qe[0])==null?void 0:St.name)||((At=qe[0])==null?void 0:At.siteName)} (${(_t=qe[0])==null?void 0:_t.confidence}% confidence)`),P=pt,console.log("[BUDGET] APPLYING TIER STRATEGY TO ALLOCATION:",{tier:A,strategy:C.name,budget:h,maxPlatforms:C.maxPlatforms,audienceLimit:C.audienceLimit});const xe=[];if(we.length===0)return null;let ft=we.filter(t=>{const i=t.actualBuyType||t["Buy Type"]||"Direct";return A==="low"?i==="Direct":A==="mid"?i==="Direct"||i==="PD":!0});console.log(`   Filtered rates: ${ft.length} (from ${we.length})`);let ge=[];v==="Awareness"||v==="VideoView"?A==="low"?ge=["Social","Display","Video"]:A==="mid"?ge=["Video","Display","Social","Native"]:ge=["Video","OTT","Display","Social","Native","Premium"]:v==="Traffic"||v==="Engagement"?A==="low"?ge=["Display","Native","Social"]:A==="mid"?ge=["Display","Video","Native","Social"]:ge=["Display","Video","Native","Social","Retargeting"]:A==="low"?ge=["Native","Display","Social"]:A==="mid"?ge=["Native","Display","Retargeting","Social"]:ge=["Native","Display","Retargeting","Video","Social"],console.log(`   Channel priority: ${ge.join(" > ")}`);const Ge=ft.sort((t,i)=>{const x=t.Pillar||t.pillar||"",T=i.Pillar||i.pillar||"",M=ge.indexOf(x),D=ge.indexOf(T),ee=M>=0?M:999,le=D>=0?D:999;return ee!==le?ee-le:A==="high"&&Q!=="Max Reach"?i.selectedCPM-t.selectedCPM:t.selectedCPM-i.selectedCPM}).slice(0,C.maxPlatforms);console.log(`   Final platforms: ${Ge.length}`),console.log(`   Mix: ${Ge.map(t=>t.Pillar).join(", ")}`);const Ke=[],Ye=Object.values(C.channelMix);Ge.forEach((t,i)=>{const x=Ye[i]||Ye[Ye.length-1];Ke.push(x)});const na=Ke.reduce((t,i)=>t+i,0),ht=Ke.map(t=>t/na);console.log(`   Allocations: ${ht.map(t=>(t*100).toFixed(0)+"%").join(", ")}`),Ge.forEach((t,i)=>{const x=ht[i],T=h*x,M=Math.floor(T/t.selectedCPM*1e3);xe.push({platform:t.Platform,pillar:t.Pillar,type:t["Type of Platform"],format:t["Ad format"]||t.Format||"",formatName:t.name||t["Ad format"]||"",budget:T,allocatedBudget:T,cpm:t.selectedCPM,impressions:M,buyType:t.actualBuyType})});const yt=new Set(xe.map(t=>t.pillar)),Je=xe.some(t=>t.buyType==="PD"),bt=xe.some(t=>t.buyType==="PG");console.log("‚úÖ TIER VALIDATION:"),console.log(`   Unique channels: ${yt.size}`),console.log(`   Has PD: ${Je}`),console.log(`   Has PG: ${bt}`),console.log(`   Line items: ${xe.length}`),A==="high"&&!Je&&console.warn("‚ö†Ô∏è Strategy warning: High budget should include PD buying type"),A==="low"&&(Je||bt)&&console.warn("‚ö†Ô∏è Strategy warning: Low budget should not include PD/PG"),xe.length===C.maxPlatforms&&yt.size<2&&console.warn("‚ö†Ô∏è Strategy failure: platform mix did not change by budget tier");let Ze=xe;if($&&$!=="Balanced"&&Mt[$]){console.log(`
[TARGET] ENFORCING CHANNEL PREFERENCE: ${$}`);const t=Mt[$];console.log(`   Minimum share required: ${(t.minShare*100).toFixed(0)}%`);const i=tt(xe,t.keywords),x=i.preferred/h;if(console.log(`   Current ${t.channelLabel} budget: RM ${i.preferred.toLocaleString()}`),console.log(`   Current ${t.channelLabel} share: ${(x*100).toFixed(1)}%`),x<t.minShare){console.log("   ‚ö†Ô∏è Below minimum! Rebalancing..."),Ze=ka(xe,t,h);const T=tt(Ze,t.keywords),M=T.preferred/h;console.log(`   ‚úÖ Adjusted ${t.channelLabel} budget: RM ${T.preferred.toLocaleString()}`),console.log(`   ‚úÖ New ${t.channelLabel} share: ${(M*100).toFixed(1)}%`)}else console.log("   ‚úÖ Already meets minimum requirement")}const Xe=Ze.map(t=>({...t,budget:t.allocatedBudget||t.budget})),je=Xe.reduce((t,i)=>t+(i.impressions||0),0),sa=Ce||E.reduce((t,i)=>t+(i.totalAudience||0),0),oa=h>0&&je>0?h/je*1e3:0,ra=S>0?h/S:h,ia=S>0&&je>0?je/S:je,Qe=Ia(Xe,A,C);Qe.length>0&&console.warn("‚ö†Ô∏è TIER COMPLIANCE WARNINGS:",Qe);const vt=Da(v,A,S||4,{geography:u.geography||[]});return console.log("üìä Generated optimization strategy:",vt.approach),{brief:u,formats:R,audiences:E,sites:P,lineItems:Xe,inventoryValidation:ie,budgetTier:A,tierStrategy:C,tierWarnings:Qe,optimizationStrategy:vt,summary:{totalBudget:h||0,totalImpressions:je||0,estimatedReach:sa||0,uniqueReach:Ce||0,simpleReachSum:E.reduce((t,i)=>t+(i.totalAudience||0),0),avgCPM:oa||0,devices:I&&I.length>0?I.join(", "):"All Devices",geography:y&&y.length>0?y.join(", "):"Malaysia",durationWeeks:S||4,weeklyBudget:ra||0,weeklyImpressions:ia||0}}},lt=async()=>{if(!r.trim()||l||X.current)return;X.current=!0;const n=r.trim();Y("user",n),f(""),w(!0);try{const e=Date.now();console.log("[AI WIZARD] Sending to OpenAI:",n),console.log("[AI WIZARD] Current brief:",H),console.log("[AI WIZARD] Conversation history:",s.length,"messages");const c=n.toLowerCase(),u=G.current,v=[/(?:don't|dont|do not|not|no)\s+want\s+(.+)/i,/(?:exclude|remove|drop)\s+(.+)/i];for(const y of v){const S=c.match(y);if(S){const re=S[1].trim(),A=u.audiences.filter(C=>{const U=(C.persona||C.name||"").toLowerCase();return U.includes(re)||re.split(/\s+/).some(R=>U.includes(R))});if(A.length>0){const C=A.map(U=>U.persona||U.name);He(U=>({...U,blacklist:[...new Set([...U.blacklist,...C])]})),console.log("[PERSONA] Blacklisted:",C)}}}const k=[/(?:i\s+)?(?:want|wanna keep|keep|include|add)\s+(.+)/i,/(?:how about|what about)\s+(.+)/i];for(const y of k){const S=c.match(y);if(S){const re=S[1].trim(),A=u.audiences.filter(C=>{const U=(C.persona||C.name||"").toLowerCase();return U.includes(re)||re.split(/\s+/).some(R=>U.includes(R))});if(A.length>0){const C=A.map(U=>U.persona||U.name);He(U=>({...U,whitelist:[...new Set([...U.whitelist,...C])]})),console.log("[PERSONA] Whitelisted:",C)}}}const h=[...s].reverse().find(y=>y.role==="assistant"),I=(h==null?void 0:h.data)||{},_=await O(n,s,H,I),Q=Date.now()-e;if(console.log(`[AI WIZARD] ‚è±Ô∏è OpenAI response received in ${Q}ms (${(Q/1e3).toFixed(1)}s)`),console.log("[AI WIZARD] OpenAI response:",_),_.success){let y=_.response;if(y.startsWith("{")||y.includes('"response"')||y.includes("extractedEntities"))try{const A=JSON.parse(y);y=A.response||A.message||y}catch{const C=y.match(/"response"\s*:\s*"([^"]+)"/);C?y=C[1]:y=y.replace(/^\{.*?"response"\s*:\s*"/i,"").replace(/".*?\}$/i,"").replace(/\{[^}]*\}/g,"").replace(/"extractedEntities".*$/i,"").trim()}y=y.replace(/\\n/g,`
`),y=y.split(`
`).map(A=>A.trim()).filter(A=>A.length>0).join(" ").trim(),(y.includes("{")||y.includes("}")||y.includes('"response"'))&&(console.warn("[AI WIZARD] JSON detected in response, cleaning further"),y=y.replace(/\{[^}]*\}/g,"").replace(/[\{\}]/g,"").replace(/"[^"]*":\s*/g,"").trim()),Y("assistant",y,_.extractedEntities),_.extractedEntities&&Object.keys(_.extractedEntities).length>0&&(console.log("[AI WIZARD] Updating brief with extracted entities:",_.extractedEntities),K(A=>{const C={...A};if(Object.entries(_.extractedEntities).forEach(([U,R])=>{R!=null&&(C[U]=R)}),!C.startDate&&s.length>0){const U=s.slice(-3).filter(R=>R.role==="user");for(const R of U){const ue=Fa(R.content);if(ue.parsed&&ue.confidence>=50){console.log("[DATE PARSER] Extracted date range:",ue),C.startDate=ue.startDate,C.endDate=ue.endDate,C.duration_weeks=ue.durationWeeks,ue.confidence<80&&console.log("[DATE PARSER] Low confidence, may need confirmation");break}}}return console.log("[AI WIZARD] Updated brief:",C),C}));const S=_.extractedEntities?{...H,..._.extractedEntities}:H;S.product_brand&&S.campaign_objective&&S.budget_rm&&S.geography&&!p&&(console.log("[AI WIZARD] Sufficient info collected, generating plan..."),setTimeout(async()=>{w(!0);try{const A={...S,industry:S.industry||"Retail",duration_weeks:S.duration_weeks||4,devices:S.devices||["Desktop","Mobile"]};console.log("üöÄ Generating plan with brief:",A);const C=Wt(A);C&&(se(C),Vt(C),setTimeout(async()=>{try{const U=await ct(!0);U&&console.log("‚úÖ Auto-saved campaign:",U)}catch(U){console.error("‚ùå Auto-save failed:",U)}},1e3))}catch(A){console.error("‚ùå Plan generation failed:",A),Y("assistant","I encountered an error generating the plan. Please try again.")}finally{w(!1)}},500))}else _.cancelled?console.log("[AI WIZARD] Request cancelled by user"):(console.error("[AI WIZARD] OpenAI error:",_.error),Y("assistant",_.response||"I'm having trouble processing that. Could you rephrase?"))}catch(e){console.error("[AI WIZARD] Error:",e),e.name!=="AbortError"&&Y("assistant","I encountered an error. Please try again or rephrase your message.")}finally{w(!1),X.current=!1}},Vt=n=>{var A,C,U,R,ue,Me;console.log("üé¨ showMediaPlan called with plan:",n?"exists":"null");const{brief:e,formats:c,audiences:u,sites:v,lineItems:k,summary:h}=n;console.log("üì¶ Destructured plan components:",{req:!!e,formats:c==null?void 0:c.length,audiences:u==null?void 0:u.length,sites:v==null?void 0:v.length,lineItems:k==null?void 0:k.length,summary:!!h}),console.log("üî® Building assumptions...");const I=[];if(e.geography.includes("Selangor")&&e.geography.includes("Kuala Lumpur")&&I.push("Klang Valley targeting"),e.buying_type==="Mixed"&&I.push("Mixed buying for best value"),e.duration_weeks===4&&!((C=(A=H._meta)==null?void 0:A.clarificationsAsked)!=null&&C.duration)&&I.push("4-week standard duration"),e._seasonalContext){const m={cny:"Chinese New Year",raya:"Hari Raya",deepavali:"Deepavali",gawai:"Gawai",valentines:"Valentine's Day",mothers_day:"Mother's Day",festive_general:"Festive Season"}[e._seasonalContext]||e._seasonalContext;I.push(`Seasonal campaign optimized for ${m}`)}if(e._culturalContext&&I.push("Cultural targeting with vernacular publisher prioritization"),e._budgetQualifier&&I.push(`${e._budgetQualifier} budget interpreted as RM ${e.budget_rm.toLocaleString()}`),e._budgetSuggested&&I.push("Budget suggested based on campaign parameters"),e.channel_preference&&e.channel_preference!=="Balanced"){const m={OTT:"OTT/Streaming",Social:"Social Media",Display:"Display"}[e.channel_preference]||e.channel_preference;I.push(`Focused on ${m} channels as requested`)}console.log("‚úÖ Assumptions built:",I.length),console.log("üî® Building strategy reasoning...");let _="";const Q=e._seasonalContext,y=e._culturalContext,S=e._productContext;if(console.log("üìä Context check:",{seasonalContext:Q,culturalContext:y,hasProductContext:!!S,productAttributes:(S==null?void 0:S.attributes)||[],contextPersonas:((U=S==null?void 0:S.personas)==null?void 0:U.slice(0,3))||[]}),Q||y){const m=[];if(Q){const q={cny:"Chinese New Year",raya:"Hari Raya",deepavali:"Deepavali",gawai:"Gawai",valentines:"Valentine's Day",mothers_day:"Mother's Day",festive_general:"Festive Season"}[Q]||Q;m.push(`**Seasonal Campaign (${q})**: This plan adapts to ${q} gifting behavior, premium festive formats, and heightened consumer spending patterns.`)}if(y){const L={malay:"Malay/Muslim community with family-centric content and vernacular publishers",chinese:"Chinese community with festive content and culturally relevant placements",indian:"Indian community with celebration-focused messaging",sabah_sarawak:"Sabah & Sarawak communities with regional cultural relevance"};m.push(`**Cultural Targeting**: Prioritizing ${L[y]||y} to match campaign context.`)}if(m.push(`**Audience Adaptation**: Selected personas reflect ${Q?"seasonal gifting intent":"cultural affinity"} and ${y?"vernacular preferences":"festive behavior"}, not generic category targeting.`),m.push("**Premium Festive Formats**: Using high-impact, OTT premium content, and culturally resonant placements‚Äîavoiding generic display-only approaches for seasonal moments."),y){const L={malay:"Malay vernacular publishers (Utusan, Berita Harian, Sinar)",chinese:"Chinese-language publishers (Sin Chew, Nanyang, Oriental Daily)",indian:"Tamil/Indian publishers (Malaysia Nanban, Makkal Osai)",sabah_sarawak:"East Malaysia regional publishers"};m.push(`**Platform Mix Override**: Prioritized ${L[y]||"culturally relevant publishers"} over generic high-traffic sites for authentic cultural resonance.`)}if(Q){const L=["cny","raya","deepavali"].includes(Q)?"Major festive season commands premium placements with higher CPMs (+50% budget adjustment)":"Seasonal campaign requires premium placements (+30% budget adjustment)";m.push(`**Budget Adjustment**: ${L} due to increased competition and need for share-of-voice during peak periods.`)}_=m.join(`

`)}else if(S&&S.attributes&&S.attributes.length>0){console.log("üìä Using product context strategy, attributes:",S.attributes);const m=[];console.log("üî® Checking product attributes..."),S.attributes.includes("halal")&&(console.log("  ‚úÖ Adding halal strategy"),m.push("**Halal Product Strategy**: This plan prioritizes Malay/Muslim audiences with family-centric messaging and culturally appropriate placements.")),S.attributes.includes("health")&&(console.log("  ‚úÖ Adding health strategy"),m.push("**Health & Wellness Positioning**: Targeting health-conscious, active lifestyle personas with wellness-focused content environments.")),S.attributes.includes("premium")&&(console.log("  ‚úÖ Adding premium strategy"),m.push("**Premium Brand Strategy**: High-income personas (T20, Luxury Seekers) with premium formats and aspirational placements‚Äîavoiding mass-market environments.")),S.attributes.includes("new_brand")&&(console.log("  ‚úÖ Adding new_brand strategy"),m.push("**New Brand Launch**: Awareness-first strategy with high reach, frequency, and brand-building formats to establish market presence.")),console.log("üî® Adding context-matched audiences line..."),m.push(`**Context-Matched Audiences**: Selected personas based on product attributes (${S.attributes.join(", ")}), not generic category defaults.`),console.log("üî® Joining bullets..., count:",m.length),_=m.join(`

`),console.log("‚úÖ Product context strategy complete, length:",_.length)}else{console.log("üìä Using standard playbook strategy"),console.log("üìä Product context check:",{hasProductContext:!!S,hasAttributes:S==null?void 0:S.attributes,attributesLength:(R=S==null?void 0:S.attributes)==null?void 0:R.length});const m=e._vertical_key||it(e.industry),L=Bt(m||e.industry);if(L){const q=[];q.push(`**${L.strategy_dna}**: This plan follows the proven ${L.label} playbook.`),L.market_truths&&L.market_truths.length>0&&q.push(`**Market context**: ${L.market_truths[0]}`);const ae=Ue(e.campaign_objective),B=L.funnel[ae]||[];if(B.length>0&&q.push(`**Funnel stage (${ae})**: I prioritized ${B.slice(0,2).map($=>$.replace(/_/g," ")).join(", ")} based on your ${e.campaign_objective} objective.`),(ue=L.creative_requirements)!=null&&ue.best_formats){const $=L.creative_requirements.best_formats.slice(0,3).map(ie=>ie.replace(/_/g," ")).join(", ");q.push(`**Format mix**: Using ${$} optimized for ${L.label} campaigns.`)}(Me=L.kpi)!=null&&Me.main_kpi&&q.push(`**Success metric**: This plan optimizes for ${L.kpi.main_kpi.replace(/_/g," ")}‚Äîthe key KPI for ${L.label}.`),_=q.join(`

`)}else e.priority==="Max Reach"?_=`I prioritized low-CPM placements to maximize your reach. This plan delivers ${h.totalImpressions.toLocaleString()} impressions across ${h.estimatedReach.toLocaleString()} people‚Äîstrong volume for ${e.campaign_objective.toLowerCase()}.`:e.priority==="Performance"?_=`I focused on premium, high-engagement formats. Higher CPM means better placement quality‚Äîideal for driving ${e.campaign_objective.toLowerCase()} results.`:_=`Balanced approach across ${k.length} platforms spreads risk while maintaining solid reach (${h.estimatedReach.toLocaleString()} people).`}console.log("‚úÖ Strategy built, length:",_.length),console.log("üî® Building response message..."),console.log("üìä Summary check:",{totalBudget:h==null?void 0:h.totalBudget,durationWeeks:h==null?void 0:h.durationWeeks,weeklyBudget:h==null?void 0:h.weeklyBudget}),console.log("üìä Request check:",{product_brand:e==null?void 0:e.product_brand,campaign_objective:e==null?void 0:e.campaign_objective,industry:e==null?void 0:e.industry});const re=`## ‚úÖ Media Plan Ready

### Campaign Strategy
${e.product_brand?`Product/Brand: ${e.product_brand}`:""}
Objective: ${e.campaign_objective}
Industry: ${e.industry}
Budget: RM ${h.totalBudget.toLocaleString()}
Duration: ${h.durationWeeks} weeks (RM ${h.weeklyBudget.toLocaleString()}/week)
Geography: ${h.geography}
Devices: ${h.devices}

${I.length>0?`Assumptions I made:
${I.map(m=>`‚Ä¢ ${m}`).join(`
`)}
`:""}

---

### Budget Allocation (${k.length} line items)

${k.map((m,L)=>`${L+1}. ${m.platform} (${m.pillar})
‚Ä¢ Budget: RM ${m.budget.toLocaleString("en-US",{maximumFractionDigits:0})} | ${m.buyType}
‚Ä¢ CPM: RM ${m.cpm.toFixed(2)}
‚Ä¢ Impressions: ${m.impressions.toLocaleString()}`).join(`

`)}

---

### Recommended Formats (${c.length})
${c.map(m=>{const L=m.confidence?` (${m.confidence}% confidence)`:"",q=m.goal?` ‚Äî ${m.goal}`:"",ae=m.reason?`
  *Why: ${m.reason}*`:"";return`‚Ä¢ ${m.name}${L}${q}${ae}`}).join(`
`)}

### Target Audiences (${u.length})
${u.map(m=>{const L=m.persona||m.name||"Unknown Audience",q=(m.totalAudience||0).toLocaleString(),ae=m.interests&&Array.isArray(m.interests)&&m.interests.length>0?` (${m.interests.filter(B=>B).slice(0,2).join(", ")})`:"";return`‚Ä¢ ${L} ‚Äî ${q} reach${ae}`}).join(`
`)}

üíæ **Save this audience group for future campaigns?**
*Click "Save Audience Group" below to reuse these ${u.length} personas in future plans.*

### Recommended Sites (${v.length})
${v.slice(0,10).map(m=>{const L=m.siteName||m.name||m.Property||"Unknown Site",q=m.category?` (${m.category})`:"",ae=(m.monthlyTraffic||m["Total impressions"]||0).toLocaleString(),B=m.confidence?` ‚Äî ${m.confidence}% match`:"",$=m.reason?`
  *Why: ${m.reason}*`:"";return`‚Ä¢ ${L}${q} ‚Äî ${ae} visits/mo${B}${$}`}).join(`
`)}

---

${(()=>{if(!n.optimizationStrategy)return"";const m=n.optimizationStrategy;return`### [TARGET] Optimization Strategy

**${m.approach}**

${m.tactics.map(L=>`‚Ä¢ ${L}`).join(`
`)}

${m.pacing?`**Pacing:** ${m.pacing}`:""}
${m.creativeNotes?`
**Creative:** ${m.creativeNotes}`:""}
`})()}

---

### Expected Results

Total Campaign:
‚Ä¢ Impressions: ${h.totalImpressions.toLocaleString()}
‚Ä¢ Reach: ${h.estimatedReach.toLocaleString()} people
‚Ä¢ Avg CPM: RM ${h.avgCPM.toFixed(2)}

Weekly Pacing:
‚Ä¢ Budget: RM ${h.weeklyBudget.toLocaleString()}/week
‚Ä¢ Impressions: ${h.weeklyImpressions.toLocaleString()}/week

${(()=>{var Be;const m=e._vertical_key||it(e.industry),L=(Be=ke.performance_benchmarks)==null?void 0:Be[m];if(!L)return"";let q="";e.campaign_objective==="Awareness"||e.campaign_objective==="VideoView"?q="awareness":e.campaign_objective==="LeadGen"?q="leads":e.campaign_objective==="Traffic"?q=L.traffic?"traffic":L.sales?"sales":"awareness":e.campaign_objective==="Conversion"&&(q=L.sales?"sales":L.acquisition?"acquisition":"leads");const ae=L[q];if(!ae)return"";const B=ke.persona_performance_modifiers;let $=1,ie=1,ve=1,we=0,Ee=[];B&&u&&u.length>0&&(u.forEach(Ce=>{const W=Ce.persona||Ce.name||"";let he=B[W];if(!he){for(const[P,ce]of Object.entries(B))if(W.includes(P)||P.includes(W)){he=ce;break}}he&&($+=he.ctr_multiplier||1,ie+=he.vtr_multiplier||1,ve+=he.lead_rate_multiplier||1,we++,Ee.push(W))}),we>0&&($=$/(we+1),ie=ie/(we+1),ve=ve/(we+1)));const Pe=we>0,E=[];if(Object.entries(ae).forEach(([Ce,W])=>{const he=Ce.replace(/_/g," ").replace(/\b\w/g,ce=>ce.toUpperCase()),P=[];if(W.avg_cpm_rm&&P.push(`CPM: RM ${W.avg_cpm_rm}`),W.expected_ctr){const ce=W.expected_ctr*$,Re=Pe?`CTR: ${(ce*100).toFixed(2)}%${$!==1?" *":""}`:`CTR: ${(W.expected_ctr*100).toFixed(2)}%`;P.push(Re)}if(W.expected_vtr){const ce=W.expected_vtr*ie,Re=Pe?`VTR: ${(ce*100).toFixed(0)}%${ie!==1?" *":""}`:`VTR: ${(W.expected_vtr*100).toFixed(0)}%`;P.push(Re)}if(W.click_to_lead_rate){const ce=W.click_to_lead_rate*ve,Re=Pe?`Lead Rate: ${(ce*100).toFixed(0)}%${ve!==1?" *":""}`:`Lead Rate: ${(W.click_to_lead_rate*100).toFixed(0)}%`;P.push(Re)}W.click_to_purchase_rate&&P.push(`Purchase Rate: ${(W.click_to_purchase_rate*100).toFixed(1)}%`),W.click_to_signup_rate&&P.push(`Signup Rate: ${(W.click_to_signup_rate*100).toFixed(0)}%`),W.click_to_booking_rate&&P.push(`Booking Rate: ${(W.click_to_booking_rate*100).toFixed(0)}%`),W.click_to_booking_engine_rate&&P.push(`To Booking: ${(W.click_to_booking_engine_rate*100).toFixed(0)}%`),W.click_to_order_rate&&P.push(`Order Rate: ${(W.click_to_order_rate*100).toFixed(0)}%`),W.target_cpl_rm&&P.push(`Target CPL: RM ${W.target_cpl_rm}`),W.target_cpa_rm&&P.push(`Target CPA: RM ${W.target_cpa_rm}`),W.target_cpc_rm&&P.push(`Target CPC: RM ${W.target_cpc_rm.toFixed(2)}`),P.length>0&&E.push(`‚Ä¢ **${he}**: ${P.join(" | ")}`)}),E.length===0)return"";const $e=Pe?`

* *Adjusted for audience: ${Ee.slice(0,2).join(", ")}${Ee.length>2?", ...":""}*`:"";return`
---

### Performance Benchmarks (${e.industry})

Industry standard metrics for ${e.campaign_objective} campaigns:

${E.join(`
`)}${$e}

*These benchmarks help set realistic expectations and optimize towards industry standards.*
`})()}

---

### Why This Works

${_}

${e._needsCreativeBuild?`
---

### üìπ Creative Build Recommendation

Since you need creative assets, I recommend including **${e.creative_asset_type==="video"?"video":"static banner"}** production in your plan:

${e.creative_asset_type==="video"?`**Video Production Package:**
‚Ä¢ 1x Hero Video (30s) for awareness campaigns
‚Ä¢ 2x Cut-downs (15s, 6s) for retargeting
‚Ä¢ Platform optimization (16:9, 9:16, 1:1 formats)
‚Ä¢ Creative testing variations (3-5 different hooks)

**Estimated Production Cost:** RM 15,000 - RM 30,000
**Timeline:** 3-4 weeks (concept ‚Üí delivery)

This ensures your media budget is supported by high-performing creative that drives results.`:`**Static Banner Production Package:**
‚Ä¢ 6-8 banner formats (Leaderboard, MREC, Mobile, etc.)
‚Ä¢ A/B testing variations (different CTAs, visuals)
‚Ä¢ Platform-specific adaptations
‚Ä¢ Responsive design for all devices

**Estimated Production Cost:** RM 5,000 - RM 12,000
**Timeline:** 1-2 weeks (concept ‚Üí delivery)

This ensures your display formats are optimized for performance across all platforms.`}
`:""}

${(()=>{const{budgetTier:m,tierStrategy:L,tierWarnings:q}=n;if(!m||!L)return"";const ae={low:{emoji:"[TARGET]",name:"Focused",color:"blue"},mid:{emoji:"[BALANCE]",name:"Balanced",color:"green"},high:{emoji:"[PREMIUM]",name:"Premium",color:"purple"}},B=ae[m]||ae.mid;let $=`---

### [BUDGET] Budget Strategy: ${B.emoji} ${B.name} Tier

**Strategy:** ${L.name}
**Approach:** ${L.focusStrategy}
**Platforms:** Up to ${L.maxPlatforms} channels
**Target Audiences:** Up to ${L.audienceLimit} personas

`;return q&&q.length>0&&($+=`
**‚ö†Ô∏è Strategic Considerations:**
${q.map(ie=>`‚Ä¢ ${ie}`).join(`
`)}
`),$})()}

${(()=>{const{inventoryValidation:m}=n;if(!m)return"";const{valid:L,severity:q,message:ae,details:B}=m;if(L&&!q)return"";let $=`---

### üìä Inventory Status

`;return L?q==="warning"?($+=`**‚ö†Ô∏è WARNING:** ${ae}
`,B&&B.utilizationPercent&&($+=`‚Ä¢ **Inventory utilization:** ${B.utilizationPercent.toFixed(0)}%
`),$+=`
**Recommendation:** This plan uses a significant portion of available inventory. Consider booking early or having backup channels.
`):q==="info"&&($+=`**‚ÑπÔ∏è NOTICE:** ${ae}
`):($+=`**üî¥ CRITICAL:** ${ae}

`,B&&(B.requestedImpressions&&($+=`‚Ä¢ **Requested:** ${B.requestedImpressions.toLocaleString()} impressions
`),B.availableImpressions&&($+=`‚Ä¢ **Available:** ${B.availableImpressions.toLocaleString()} impressions
`),B.shortfall&&($+=`‚Ä¢ **Shortfall:** ${B.shortfall.toLocaleString()} impressions (${(B.shortfall/B.requestedImpressions*100).toFixed(0)}%)
`)),$+=`
**Recommendation:** Consider extending campaign duration, reducing target impressions, or expanding to additional channels.
`),$})()}

${(()=>{const{summary:m}=n;if(!m||!m.uniqueReach||!m.simpleReachSum)return"";const L=(m.simpleReachSum-m.uniqueReach)/m.simpleReachSum*100;return L<5?"":`---

### üë• Audience Reach Analysis

**Simple Sum:** ${m.simpleReachSum.toLocaleString()} people
**Unique Reach:** ${m.uniqueReach.toLocaleString()} people
**Audience Overlap:** ~${L.toFixed(0)}%

*The unique reach accounts for overlap between your target audiences, giving you a more accurate estimate of actual people reached.*

`})()}

Need adjustments? Just tell me what you'd like to change.`;console.log("üì® About to send plan message, response length:",re.length),Y("assistant",re,n),console.log("‚úÖ Plan message sent successfully")},zt=n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),lt())},Ht=async()=>{try{Y("assistant","Saving your campaign as a draft..."),await ct(!0)&&Y("assistant","Campaign saved as draft successfully! You can find it in your campaigns list.")}catch(n){console.error("[SAVE DRAFT ERROR]",n),Y("assistant","Sorry, there was an error saving the draft. Please try again.")}},Ut=async()=>{try{if(!p||!p.brief){Y("assistant","Cannot export: Campaign plan is incomplete.");return}Y("assistant","Generating Excel file...");const n={campaignPlan:{campaignName:p.brief.product_brand||p.brief.campaignName||"Campaign Plan",...p.brief},budgetChannels:p.channels||[],availableSites:Ae.sites||[]},e=await de.post("/api/export/kult-template",n,{responseType:"blob"}),c=window.URL.createObjectURL(new Blob([e.data])),u=document.createElement("a");u.href=c,u.setAttribute("download",`KULT_MediaPlan_${n.campaignPlan.campaignName.replace(/\s+/g,"_")}.xlsx`),document.body.appendChild(u),u.click(),u.remove(),window.URL.revokeObjectURL(c),Y("assistant","Excel file downloaded! Check your downloads folder.")}catch(n){console.error("[EXPORT EXCEL ERROR]",n),Y("assistant","Sorry, there was an error generating the Excel file. Please try again.")}},qt=async()=>{try{if(!p||!p.brief){Y("assistant","Cannot export: Campaign plan is incomplete.");return}Y("assistant","Generating PDF file...");const n={campaignPlan:{campaignName:p.brief.product_brand||p.brief.campaignName||"Campaign Plan",...p.brief},budgetChannels:p.channels||[],availableSites:Ae.sites||[]},e=await de.post("/api/export/kult-template-pdf",n,{responseType:"blob"}),c=window.URL.createObjectURL(new Blob([e.data])),u=document.createElement("a");u.href=c,u.setAttribute("download",`KULT_MediaPlan_${n.campaignPlan.campaignName.replace(/\s+/g,"_")}.pdf`),document.body.appendChild(u),u.click(),u.remove(),window.URL.revokeObjectURL(c),Y("assistant","PDF file downloaded! Check your downloads folder.")}catch(n){console.error("[EXPORT PDF ERROR]",n),Y("assistant","Sorry, there was an error generating the PDF file. Please try again.")}},ct=async(n=!0)=>{var e;if(!p)return Y("assistant","No plan to save yet. Let me generate recommendations first!"),null;try{const c={campaignName:`${p.brief.product_brand||p.brief.industry||"Campaign"} - ${p.brief.campaign_objective||"Awareness"}`,brandProduct:p.brief.product_brand||"",objective:p.brief.campaign_objective||"Awareness",industry:p.brief.industry||"",totalBudget:p.brief.budget_rm||0,startDate:new Date().toISOString().split("T")[0],endDate:p.brief.duration_weeks?new Date(Date.now()+p.brief.duration_weeks*7*24*60*60*1e3).toISOString().split("T")[0]:new Date(Date.now()+2592e6).toISOString().split("T")[0],selectedPersonas:((e=p.audiences)==null?void 0:e.map(h=>h.name))||[],selectedFormats:p.formats||[],selectedSites:[],geography:Array.isArray(p.brief.geography)?p.brief.geography:p.brief.geography?[p.brief.geography]:["Malaysia"],devices:p.brief.devices||["Desktop","Mobile"],optimisedGroups:[],createdBy:"AI Wizard",source:"ai_wizard",aiGenerated:!0,currentStep:5},u=[];p.channels&&p.channels.forEach((h,I)=>{u.push({id:`channel_${I}`,name:h.name||h.channel||"Channel",budget:h.budget||0,cpm:h.cpm||15,baseCpm:h.cpm||15,baseBudget:h.budget||0,impressions:h.impressions||0,weight:h.weight||0,hasLoading:!1,color:I===0?"from-green-500":I===1?"from-blue-500":"from-purple-500"})});const v={campaignPlan:c,budgetChannels:u,status:n?"draft":"booked"},k=await de.post("/api/campaigns",v);if(k.data.success){const h=k.data.campaign;console.log("‚úÖ Campaign auto-saved:",h.id);const I={id:h.id,name:c.campaignName,brief:p.brief,recommendations:p,createdAt:new Date().toISOString()},_=JSON.parse(localStorage.getItem("aiCampaignPlans")||"[]");return _.push(I),localStorage.setItem("aiCampaignPlans",JSON.stringify(_)),h.id}}catch(c){console.error("‚ùå Auto-save failed:",c);const u={name:`AI Plan - ${p.brief.product_brand||p.brief.industry} ${p.brief.campaign_objective} - ${new Date().toLocaleDateString()}`,brief:p.brief,recommendations:p,createdAt:new Date().toISOString()},v=JSON.parse(localStorage.getItem("aiCampaignPlans")||"[]");return v.push(u),localStorage.setItem("aiCampaignPlans",JSON.stringify(v)),null}},Kt=()=>{console.log("[AI WIZARD] Stopping AI request..."),F(),w(!1),X.current=!1,Y("assistant","Request stopped. Feel free to ask me anything else!")},ut=()=>{if(s.length>1||p){ze(!0);return}dt()},dt=()=>{console.log("[AI WIZARD] Clearing all data and starting fresh"),o([]),K({product_brand:null,campaign_objective:null,industry:null,budget_rm:null,geography:[],audience:null,duration_weeks:null,devices:[],buying_type:null,priority:null,_extractionLog:[],_budgetAsked:!1,_needsBudgetSuggestion:!1,_budgetSuggested:!1,_showingTiers:!1}),se(null),d(null),f(""),He({blacklist:[],whitelist:[]}),Y("assistant","Fresh start! Let's create something amazing. What are you working on?")},Yt=async()=>{if(!me.trim()){alert("Please enter a group name");return}const n={name:me,personas:p.audiences.map(e=>e.persona||e.name||"Unknown"),totalReach:p.audiences.reduce((e,c)=>e+(c.totalAudience||0),0),uniqueReach:p.summary.uniqueReach||0,industry:p.brief.industry,objective:p.brief.campaign_objective,geography:p.brief.geography||[],createdAt:new Date().toISOString(),createdBy:"AI Wizard"};try{const e=await de.post("/api/audience-groups",n);if(e.data.success){const c=e.data.data;Le(u=>[...u,c]),ye(!1),fe(""),Y("assistant",`Audience group "${me}" saved! You can reuse it in future campaigns from the Target Segment tab.`)}}catch(e){console.error("Error saving audience group:",e);const c=JSON.parse(localStorage.getItem("savedAudienceGroups")||"[]"),u={...n,id:Date.now().toString()};c.push(u),localStorage.setItem("savedAudienceGroups",JSON.stringify(c)),Le(v=>[...v,u]),ye(!1),fe(""),Y("assistant",`Audience group "${me}" saved locally! You can reuse it in future campaigns.`)}},mt=async(n,e)=>{const c=s[n];if(!(!c||c.role!=="assistant")){nt(u=>({...u,[n]:e}));try{await de.post("/api/ai-chat/feedback",{conversationId:oe.current,messageIndex:n,messageContent:c.content,feedback:e,context:{brief:H,timestamp:new Date().toISOString()}}),console.log(`üìä Feedback recorded: ${e} for message ${n}`)}catch(u){console.error("Error sending feedback:",u)}}},Jt=async n=>{var c;console.log(`[REGENERATE] Regenerating response for message ${n}`);const e=(c=s[n-1])==null?void 0:c.content;if(!e){console.error("[REGENERATE] No user message found");return}w(!0);try{const u=await O(e,s.slice(0,n-1),H);u.success&&o(v=>{const k=[...v];return k[n]={...k[n],content:u.response,regenerated:!0},k})}catch(u){console.error("[REGENERATE] Error:",u),Y("assistant","I couldn't regenerate that response. Please try again.")}finally{w(!1)}},Zt=async n=>{var u,v;console.log(`[COMPARISON] Generating A/B options for message ${n}`);const e=(u=s[n-1])==null?void 0:u.content,c=(v=s[n])==null?void 0:v.content;if(!e||!c){console.error("[COMPARISON] Missing message data");return}rt(n),Ie(k=>({...k,[n]:{optionA:c,optionB:null,loading:!0}}));try{const k=await O(e,s.slice(0,n-1),H);k.success&&Ie(h=>({...h,[n]:{optionA:c,optionB:k.response,loading:!1}}))}catch(k){console.error("[COMPARISON] Error generating option B:",k),Ie(h=>{const I={...h};return delete I[n],I})}finally{rt(null)}},gt=async(n,e,c,u)=>{var v;console.log(`[COMPARISON] User selected ${e} for message ${n}`);try{await de.post("/api/ai-chat/comparison-feedback",{conversationId:oe.current,messageIndex:n,userMessage:((v=s[n-1])==null?void 0:v.content)||"",optionA:c,optionB:u,preferredOption:e,context:{brief:H,timestamp:Date.now()}}),console.log(`[COMPARISON] Preference recorded: ${e}`);const k=e==="A"?c:u;o(h=>{const I=[...h];return I[n]={...I[n],content:k,comparedAndSelected:!0,selectedOption:e},I}),Ie(h=>{const I={...h};return delete I[n],I})}catch(k){console.error("[COMPARISON] Error recording preference:",k)}},Xt=n=>{Ie(e=>{const c={...e};return delete c[n],c})},Qt=async(n,e)=>{var c;console.log(`[REPORT] Message ${n} reported: ${e}`);try{await de.post("/api/ai-chat/feedback",{conversationId:oe.current,messageIndex:n,messageContent:((c=s[n])==null?void 0:c.content)||"",feedback:"report",reportReason:e,context:{brief:H,timestamp:new Date().toISOString()}}),nt(u=>({...u,[n]:"reported"})),ot(null),console.log(`üìä Report recorded: ${e} for message ${n}`)}catch(u){console.error("Error sending report:",u)}};z.useEffect(()=>{(async()=>{try{const e=await de.get("/api/audience-groups");e.data.success&&Le(e.data.data||[])}catch{const c=JSON.parse(localStorage.getItem("savedAudienceGroups")||"[]");Le(c)}})()},[]);const ea=n=>{const e=s[n];e.role==="user"&&(d(n),j(e.content))},ta=()=>{d(null),j("")},aa=async()=>{if(!b.trim()||g===null)return;const n=b.trim(),e=s.slice(0,g);o(e),Y("user",n),d(null),j(""),w(!0);try{console.log("[EDIT] Sending edited message to backend:",n),console.log("[EDIT] Conversation history:",e.length,"messages"),console.log("[EDIT] Current brief:",H);const c=await O(n,e,H);if(console.log("[EDIT] Backend response:",c),c.success){let u=c.response;if(u.startsWith("{")||u.includes('"response"'))try{u=JSON.parse(u).response||u}catch{const k=u.match(/"response"\s*:\s*"([^"]+)"/);k&&(u=k[1])}if(u=u.replace(/\\n/g,`
`),u&&u.trim()){if(Y("assistant",u,c.extractedEntities),c.extractedEntities){console.log("[EDIT] Updating brief with:",c.extractedEntities);const v={...H};Object.keys(c.extractedEntities).forEach(k=>{c.extractedEntities[k]!==null&&c.extractedEntities[k]!==void 0&&(v[k]=c.extractedEntities[k])}),K(v),console.log("[EDIT] Updated brief:",v)}}else console.error("[EDIT] Empty response"),Y("assistant","I apologize, I didn't generate a proper response. Could you please repeat that?")}else console.error("[EDIT] API error:",c.error),Y("assistant","I apologize, there was an error processing your message. Could you please try again?")}catch(c){console.error("[EDIT] Error:",c),Y("assistant","I apologize, there was an error processing your message. Could you please try again?")}finally{w(!1)}};return a.jsxs(ua,{children:[a.jsx(da,{brief:H,onUpdate:Et,isCollapsed:N,onCollapseChange:Z}),a.jsxs("div",{className:`min-h-screen bg-[#0a0a0a] transition-all duration-300 ${N?"mr-0":"mr-0 lg:mr-[320px]"}`,children:[a.jsx("div",{className:"border-b border-gray-800 bg-[#0f0f0f] px-4 sm:px-6 lg:px-8 py-4 sm:py-6",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-xs text-cyan-400 font-black mb-2 tracking-wider uppercase",style:{fontFamily:"Inter, sans-serif"},children:"[ KULT AI MEDIA STRATEGIST ]"}),a.jsx("h1",{className:"text-2xl sm:text-3xl font-black text-white uppercase",style:{fontFamily:"Inter, sans-serif"},children:"Campaign Planner"}),a.jsx("p",{className:"text-gray-400 mt-1 text-sm",children:"Natural conversation ‚Ä¢ Smart extraction ‚Ä¢ Data-driven plans"})]}),a.jsxs("div",{className:"flex gap-2",children:[H.campaignName&&a.jsxs("button",{onClick:()=>Ht(),disabled:l,className:"px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",title:"Save current campaign as draft",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"})}),a.jsx("span",{className:"hidden sm:inline",children:"Save as Draft"})]}),a.jsxs("button",{onClick:ut,disabled:l,className:"px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",title:"Start a new campaign",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),a.jsx("span",{className:"hidden sm:inline",children:"New Campaign"})]}),s.length>0&&a.jsxs("button",{onClick:ut,disabled:l,className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",title:"Clear all conversation and start fresh",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),a.jsx("span",{className:"hidden sm:inline",children:"Clear All"})]})]})]})}),a.jsx("div",{className:"max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6 flex flex-col h-[calc(100vh-180px)]",style:{minHeight:"500px"},children:a.jsxs("div",{className:"flex-1 bg-[#0f0f0f] border border-gray-800 rounded-lg overflow-hidden flex flex-col",children:[a.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[s.map((n,e)=>{var c,u;return a.jsx("div",{className:`flex ${n.role==="user"?"justify-end":"justify-start"}`,children:a.jsxs("div",{className:`max-w-[85%] sm:max-w-[75%] rounded-lg p-4 ${n.role==="user"?"bg-cyan-600 text-white":"bg-[#1a1a1a] text-gray-100 border border-gray-800"}`,children:[n.role==="assistant"&&a.jsxs("div",{className:"flex items-center gap-2 mb-2 text-cyan-400",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"})}),a.jsx("span",{className:"text-xs font-bold",children:"Strategist"})]}),n.role==="user"&&g===e?a.jsxs("div",{className:"space-y-2",children:[a.jsx("textarea",{value:b,onChange:v=>j(v.target.value),className:"w-full bg-cyan-700 text-white p-2 rounded text-sm resize-none focus:outline-none focus:ring-2 focus:ring-cyan-400",rows:3,autoFocus:!0}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{onClick:aa,className:"px-3 py-1 bg-white text-cyan-600 text-xs font-medium rounded hover:bg-gray-100 transition-colors",children:"Save & Regenerate"}),a.jsx("button",{onClick:ta,className:"px-3 py-1 bg-cyan-700 text-white text-xs font-medium rounded hover:bg-cyan-800 transition-colors",children:"Cancel"})]})]}):a.jsx("div",{className:"whitespace-pre-wrap text-sm leading-relaxed",children:n.content.split(`
`).map((v,k)=>{if(v.startsWith("###"))return a.jsx("h3",{className:"text-base font-bold text-cyan-400 mt-3 mb-2",children:v.replace("###","").trim()},k);if(v.startsWith("##"))return a.jsx("h2",{className:"text-lg font-bold text-white mt-4 mb-2",children:v.replace("##","").trim()},k);if(v==="---")return a.jsx("div",{className:"border-t border-gray-700 my-3"},k);if(/^[A-Z][A-Z\s&]+:/.test(v.trim())&&v.trim().length>10)return a.jsx("h3",{className:"text-base font-bold text-cyan-400 mt-3 mb-2",children:v.trim()},k);const h=I=>{const _=/(https?:\/\/[^\s]+)/g;return I.split(_).map((y,S)=>y.match(_)?a.jsx("a",{href:y,target:"_blank",rel:"noopener noreferrer",className:"text-cyan-400 hover:text-cyan-300 underline",children:y},S):y.split(/(\*\*.*?\*\*)/g).map((A,C)=>A.startsWith("**")&&A.endsWith("**")?a.jsx("strong",{className:"text-cyan-400 font-semibold",children:A.replace(/\*\*/g,"")},`${S}-${C}`):a.jsx("span",{children:A},`${S}-${C}`)))};return v.startsWith("‚Ä¢")?a.jsx("div",{className:"ml-4 my-1",children:h(v)},k):a.jsx("div",{children:h(v)},k)})}),n.role==="assistant"&&((c=n.data)==null?void 0:c.showActions)&&e===s.length-1&&a.jsx("div",{className:"mt-6 pt-4",children:a.jsx("div",{className:"flex flex-col gap-3",children:a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[a.jsxs("button",{onClick:()=>qt(),className:"flex items-center justify-center gap-3 px-6 py-4 bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600 text-white rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl",children:[a.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"})}),a.jsx("span",{className:"font-medium",children:"Export to PDF"})]}),a.jsxs("button",{onClick:()=>Ut(),className:"flex items-center justify-center gap-3 px-6 py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl transition-all duration-200 border border-green-500 hover:border-green-400",children:[a.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),a.jsx("span",{className:"font-medium",children:"Export to Excel"})]})]})})}),n.role==="assistant"&&!((u=n.data)!=null&&u.showActions&&e===s.length-1)&&a.jsxs("div",{className:"flex items-center gap-2 mt-3 pt-3 border-t border-gray-700",children:[a.jsx("button",{onClick:()=>mt(e,"like"),className:`p-1.5 rounded transition-colors ${Se[e]==="like"?"text-green-500":"text-gray-400 hover:text-gray-200"}`,title:"Good response",children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"})})}),a.jsx("button",{onClick:()=>mt(e,"dislike"),className:`p-1.5 rounded transition-colors ${Se[e]==="dislike"?"text-red-500":"text-gray-400 hover:text-gray-200"}`,title:"Poor response",children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"})})}),a.jsx("button",{onClick:()=>Jt(e),className:"p-1.5 rounded transition-colors text-gray-400 hover:text-gray-200",title:"Regenerate response",disabled:l,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})}),a.jsxs("div",{className:"relative",children:[a.jsx("button",{onClick:()=>ot(st===e?null:e),className:"p-1.5 rounded transition-colors text-gray-400 hover:text-gray-200",title:"Report issue",children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"})})}),st===e&&a.jsx("div",{className:"absolute left-0 mt-2 w-64 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-10",children:a.jsxs("div",{className:"p-2",children:[a.jsx("div",{className:"text-xs text-gray-400 font-semibold mb-2 px-2",children:"Report an issue:"}),[{value:"not_relevant",label:"Response is not relevant"},{value:"incorrect_info",label:"Incorrect information"},{value:"incomplete",label:"Incomplete response"},{value:"confusing",label:"Confusing or unclear"},{value:"offensive",label:"Offensive content"},{value:"other",label:"Other issue"}].map(v=>a.jsx("button",{onClick:()=>Qt(e,v.value),className:"w-full text-left px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded transition-colors",children:v.label},v.value))]})})]}),!be[e]&&a.jsx("button",{onClick:()=>Zt(e),className:"p-1.5 rounded transition-colors text-gray-400 hover:text-gray-200",title:"Compare with alternative response",disabled:l||jt===e,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"})})}),Se[e]&&a.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:[Se[e]==="like"&&"Thanks for your feedback!",Se[e]==="dislike"&&"Thanks! We'll improve.",Se[e]==="reported"&&"Report submitted. Thank you!"]})]}),be[e]&&n.role==="assistant"&&a.jsxs("div",{className:"mt-4 border-t border-gray-700 pt-4",children:[a.jsxs("div",{className:"text-xs text-cyan-400 font-semibold mb-3 flex items-center gap-2",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"})}),"Which response do you prefer?"]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-3",children:[a.jsx("div",{className:"text-xs font-bold text-yellow-400 mb-2",children:"OPTION A"}),a.jsx("div",{className:"text-sm text-gray-300 mb-3 max-h-40 overflow-y-auto",children:be[e].optionA}),a.jsx("button",{onClick:()=>gt(e,"A",be[e].optionA,be[e].optionB),className:"w-full px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-medium rounded transition-colors",disabled:be[e].loading,children:"Choose Option A"})]}),a.jsxs("div",{className:"bg-gray-900 border border-gray-700 rounded-lg p-3",children:[a.jsx("div",{className:"text-xs font-bold text-purple-400 mb-2",children:"OPTION B"}),be[e].loading?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsxs("div",{className:"relative w-12 h-12",children:[a.jsx("div",{className:"absolute inset-0 rounded-full border-3 border-gray-800"}),a.jsx("div",{className:"absolute inset-0 rounded-full border-3 border-transparent border-t-purple-400 animate-spin"})]})}):a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-sm text-gray-300 mb-3 max-h-40 overflow-y-auto",children:be[e].optionB}),a.jsx("button",{onClick:()=>gt(e,"B",be[e].optionA,be[e].optionB),className:"w-full px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium rounded transition-colors",children:"Choose Option B"})]})]})]}),a.jsx("button",{onClick:()=>Xt(e),className:"mt-3 px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs rounded transition-colors",children:"Cancel Comparison"})]}),n.role==="user"&&g!==e&&a.jsxs("button",{onClick:()=>ea(e),className:"mt-2 text-xs text-cyan-200 hover:text-white flex items-center gap-1 transition-colors",disabled:l,children:[a.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"Edit"]}),a.jsx("div",{className:"text-xs text-gray-500 mt-2",children:n.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},e)}),l&&a.jsx("div",{className:"flex justify-start",children:a.jsx("div",{className:"bg-[#1a1a1a] border border-gray-800 rounded-lg p-4",children:a.jsxs("div",{className:"flex items-center gap-2 text-cyan-400",children:[a.jsx("div",{className:"w-2 h-2 bg-cyan-400 rounded-full animate-pulse"}),a.jsx("div",{className:"w-2 h-2 bg-cyan-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),a.jsx("div",{className:"w-2 h-2 bg-cyan-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]})})}),a.jsx("div",{ref:pe})]}),a.jsx("div",{className:"border-t border-gray-800 bg-[#0a0a0a] p-4",children:a.jsxs("div",{className:"flex gap-2",children:[a.jsx("input",{ref:J,type:"text",value:r,onChange:n=>f(n.target.value),onKeyPress:zt,placeholder:"Tell me about your campaign...",disabled:l,className:"flex-1 px-4 py-3 bg-[#1a1a1a] border border-gray-700 rounded-lg text-white text-sm focus:border-cyan-500 focus:outline-none disabled:opacity-50"}),a.jsx("button",{onClick:l?Kt:lt,disabled:!l&&!r.trim(),className:`px-6 py-3 ${l?"bg-red-600 hover:bg-red-700":"bg-gradient-to-r from-cyan-500 to-purple-600 hover:from-cyan-600 hover:to-purple-700"} text-white font-medium rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2`,title:l?"Stop AI processing":"Powered by OpenAI GPT-4o-mini",children:l?a.jsxs(a.Fragment,{children:[a.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),a.jsx("span",{children:"Stop"})]}):a.jsxs(a.Fragment,{children:[a.jsx("span",{children:"Send"}),a.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})})]})})]})})]})})]}),Ve&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:a.jsxs("div",{className:"bg-[#1a1a1a] border border-gray-800 rounded-lg p-6 w-full max-w-md",children:[a.jsx("h3",{className:"text-xl font-bold text-white mb-4",children:"Save Audience Group"}),p&&p.audiences&&a.jsxs("div",{className:"mb-4",children:[a.jsxs("p",{className:"text-gray-400 text-sm mb-2",children:["Saving ",p.audiences.length," personas:"]}),a.jsx("div",{className:"bg-gray-900 rounded p-3 max-h-32 overflow-y-auto",children:p.audiences.map((n,e)=>a.jsxs("div",{className:"text-cyan-400 text-xs mb-1",children:["‚Ä¢ ",n.persona||n.name||"Unknown"," (",(n.totalAudience||0).toLocaleString()," reach)"]},e))})]}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-gray-400 text-sm mb-2",children:"Group Name"}),a.jsx("input",{type:"text",value:me,onChange:n=>fe(n.target.value),className:"w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white focus:outline-none focus:border-cyan-500",placeholder:"e.g., Samsung - Awareness Campaign"})]}),a.jsxs("div",{className:"flex gap-2 justify-end",children:[a.jsx("button",{onClick:()=>{ye(!1),fe("")},className:"px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded transition-colors",children:"Cancel"}),a.jsx("button",{onClick:Yt,className:"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded transition-colors",children:"Save Group"})]})]})}),It&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:a.jsxs("div",{className:"bg-[#1a1a1a] border border-gray-800 rounded-lg p-6 w-full max-w-md",children:[a.jsx("h3",{className:"text-xl font-bold text-white mb-4",children:"Clear All Conversations?"}),a.jsx("p",{className:"text-gray-400 text-sm mb-6",children:"Are you sure you want to clear all conversation and start fresh? Any unsaved campaign data will be lost."}),a.jsxs("div",{className:"flex gap-3 justify-end",children:[a.jsx("button",{onClick:()=>ze(!1),className:"px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded transition-colors",children:"Cancel"}),a.jsx("button",{onClick:()=>{ze(!1),dt()},className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded transition-colors",children:"Clear All"})]})]})})]})}export{qa as default};
